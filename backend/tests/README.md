# æµ‹è¯•åŸºç¡€è®¾æ–½è¯´æ˜

## ğŸ“‹ æµ‹è¯•ç¯å¢ƒé…ç½®

### æ•°æ®åº“é…ç½®

#### PostgreSQLæµ‹è¯•æ•°æ®åº“
- **åœ°å€**: 192.168.66.10
- **ç«¯å£**: 5432
- **æ•°æ®åº“**: `cozychat_test`ï¼ˆéœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼‰
- **ç”¨æˆ·å**: cozychat
- **å¯†ç **: passw0rd

**åˆ›å»ºæµ‹è¯•æ•°æ®åº“**:
```sql
CREATE DATABASE cozychat_test;
```

#### Redisï¼ˆæµ‹è¯•æ—¶ä½¿ç”¨Mockï¼‰
- **åœ°å€**: 192.168.66.10
- **ç«¯å£**: 6379
- **å¯†ç **: redis_passw0rd
- **æ³¨æ„**: æµ‹è¯•æ—¶é»˜è®¤ä½¿ç”¨Mockï¼Œä¸è¿æ¥çœŸå®Redis

#### Qdrantï¼ˆæµ‹è¯•æ—¶ä½¿ç”¨Mockï¼‰
- **åœ°å€**: 192.168.66.10
- **ç«¯å£**: 6333
- **æ³¨æ„**: æµ‹è¯•æ—¶é»˜è®¤ä½¿ç”¨Mockï¼Œä¸è¿æ¥çœŸå®Qdrant

#### ChromaDBï¼ˆæµ‹è¯•æ—¶ä½¿ç”¨ä¸´æ—¶ç›®å½•ï¼‰
- **å­˜å‚¨**: æµ‹è¯•æ—¶ä½¿ç”¨ä¸´æ—¶ç›®å½•ï¼Œæµ‹è¯•åè‡ªåŠ¨æ¸…ç†
- **æ³¨æ„**: ä¸ä¼šå½±å“ç”Ÿäº§æ•°æ®

### ç¯å¢ƒå˜é‡

æµ‹è¯•æ—¶è‡ªåŠ¨è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š
- `DATABASE_URL`: æµ‹è¯•æ•°æ®åº“URL
- `REDIS_URL`: Redisè¿æ¥URLï¼ˆæµ‹è¯•æ—¶ä½¿ç”¨Mockï¼‰
- `QDRANT_URL`: Qdrantè¿æ¥URLï¼ˆæµ‹è¯•æ—¶ä½¿ç”¨Mockï¼‰
- `CHROMADB_PERSIST_DIR`: ä¸´æ—¶ChromaDBç›®å½•

## ğŸ”§ æµ‹è¯•Fixtures

### æ•°æ®åº“Fixtures

- `db_session`: å¼‚æ­¥æ•°æ®åº“ä¼šè¯
- `sync_db_session`: åŒæ­¥æ•°æ®åº“ä¼šè¯
- `client`: FastAPIåŒæ­¥æµ‹è¯•å®¢æˆ·ç«¯
- `async_client`: FastAPIå¼‚æ­¥æµ‹è¯•å®¢æˆ·ç«¯

### Mock Fixtures

- `mock_openai_client`: Mock OpenAIå®¢æˆ·ç«¯
- `mock_chromadb`: Mock ChromaDBå®¢æˆ·ç«¯å’Œé›†åˆ
- `mock_qdrant_client`: Mock Qdrantå®¢æˆ·ç«¯å’Œé›†åˆ
- `mock_redis`: Mock Rediså®¢æˆ·ç«¯

### æµ‹è¯•æ•°æ®Fixtures

- `test_user_data`: æµ‹è¯•ç”¨æˆ·æ•°æ®
- `test_personality_data`: æµ‹è¯•äººæ ¼æ•°æ®
- `temp_chromadb_dir`: ä¸´æ—¶ChromaDBç›®å½•

## ğŸš€ è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
cd backend
source venv/bin/activate
pytest
```

### è¿è¡Œç‰¹å®šæµ‹è¯•
```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/test_engines/ -v

# è¿è¡ŒAPIæµ‹è¯•
pytest tests/test_api/ -v

# è¿è¡ŒåŸºç¡€è®¾æ–½æµ‹è¯•
pytest tests/test_infrastructure.py -v
```

### æŸ¥çœ‹è¦†ç›–ç‡
```bash
pytest --cov=app --cov-report=html
# æ‰“å¼€ htmlcov/index.html æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š
```

## ğŸ“ æµ‹è¯•è§„èŒƒ

### å•å…ƒæµ‹è¯•
- ä½¿ç”¨Mockéš”ç¦»å¤–éƒ¨ä¾èµ–
- æµ‹è¯•å•ä¸ªå‡½æ•°/ç±»çš„åŠŸèƒ½
- è¦†ç›–ç‡ç›®æ ‡ï¼šâ‰¥80%

### APIæµ‹è¯•
- ä½¿ç”¨TestClientæµ‹è¯•APIæ¥å£
- éªŒè¯è¯·æ±‚/å“åº”æ ¼å¼
- æµ‹è¯•é”™è¯¯å¤„ç†

### é›†æˆæµ‹è¯•
- ä½¿ç”¨æµ‹è¯•æ•°æ®åº“
- æµ‹è¯•æ¨¡å—é—´äº¤äº’
- éªŒè¯æ•°æ®æµ

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æµ‹è¯•æ•°æ®åº“**: ç¡®ä¿æµ‹è¯•æ•°æ®åº“å·²åˆ›å»ºï¼Œæµ‹è¯•ä¸ä¼šå½±å“ç”Ÿäº§æ•°æ®
2. **Mockä½¿ç”¨**: å¤–éƒ¨æœåŠ¡ï¼ˆOpenAIã€Redisã€Qdrantï¼‰é»˜è®¤ä½¿ç”¨Mock
3. **æ•°æ®æ¸…ç†**: æµ‹è¯•åæ•°æ®ä¼šè‡ªåŠ¨æ¸…ç†ï¼ˆå¯é€‰ï¼Œå¯ä¿ç•™ç”¨äºè°ƒè¯•ï¼‰
4. **å¹¶å‘æµ‹è¯•**: ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“ï¼Œæ”¯æŒå¹¶å‘æµ‹è¯•

## ğŸ” è°ƒè¯•æµ‹è¯•

### ä¿ç•™æµ‹è¯•æ•°æ®
åœ¨ `conftest.py` ä¸­æ³¨é‡Šæ‰æ•°æ®æ¸…ç†ä»£ç ï¼š
```python
# æ¸…ç†æ‰€æœ‰è¡¨ï¼ˆå¯é€‰ï¼Œä¿ç•™æ•°æ®ç”¨äºè°ƒè¯•ï¼‰
# async with test_async_engine.begin() as conn:
#     await conn.run_sync(Base.metadata.drop_all)
```

### æŸ¥çœ‹æµ‹è¯•æ—¥å¿—
```bash
pytest -v -s  # -s æ˜¾ç¤ºprintè¾“å‡º
```

### è¿è¡Œå•ä¸ªæµ‹è¯•
```bash
pytest tests/test_infrastructure.py::TestDatabaseFixtures::test_async_db_session -v
```

