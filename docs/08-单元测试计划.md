# CozyChat å•å…ƒæµ‹è¯•è®¡åˆ’

> **æ–‡æ¡£ä½ç½®**: `docs/08-å•å…ƒæµ‹è¯•è®¡åˆ’.md`  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-07  
> **ç›¸å…³æ–‡æ¡£**: [07-æµ‹è¯•è§„èŒƒ.md](07-æµ‹è¯•è§„èŒƒ.md), [07-æµ‹è¯•å°±ç»ªæ€§è¯„ä¼°.md](07-æµ‹è¯•å°±ç»ªæ€§è¯„ä¼°.md)

## ğŸ“‹ ç›®å½•

- [1. æµ‹è¯•èŒƒå›´åˆ†æ](#1-æµ‹è¯•èŒƒå›´åˆ†æ)
- [2. æµ‹è¯•ä¼˜å…ˆçº§](#2-æµ‹è¯•ä¼˜å…ˆçº§)
- [3. æµ‹è¯•ç”¨ä¾‹è®¾è®¡](#3-æµ‹è¯•ç”¨ä¾‹è®¾è®¡)
- [4. æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡](#4-æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡)
- [5. æµ‹è¯•æ‰§è¡Œè®¡åˆ’](#5-æµ‹è¯•æ‰§è¡Œè®¡åˆ’)
- [6. æµ‹è¯•æ•°æ®ç®¡ç†](#6-æµ‹è¯•æ•°æ®ç®¡ç†)
- [7. Mockç­–ç•¥](#7-mockç­–ç•¥)
- [8. æµ‹è¯•å·¥å…·å’Œç¯å¢ƒ](#8-æµ‹è¯•å·¥å…·å’Œç¯å¢ƒ)

---

## 1. æµ‹è¯•èŒƒå›´åˆ†æ

### 1.1 ä»£ç æ¨¡å—ç»Ÿè®¡

æ ¹æ®ä»£ç æ‰«æï¼Œéœ€è¦æµ‹è¯•çš„æ¨¡å—å¦‚ä¸‹ï¼š

#### æ ¸å¿ƒä¸šåŠ¡æ¨¡å—ï¼ˆCoreï¼‰
- **ç”¨æˆ·ç³»ç»Ÿ** (5ä¸ªæ–‡ä»¶)
  - `app/core/user/auth.py` - è®¤è¯æœåŠ¡
  - `app/core/user/manager.py` - ç”¨æˆ·ç®¡ç†
  - `app/core/user/permissions.py` - æƒé™ç®¡ç†
  - `app/core/user/profile.py` - ç”¨æˆ·ç”»åƒ
  - `app/core/user/stats.py` - ç”¨æˆ·ç»Ÿè®¡

- **äººæ ¼ç³»ç»Ÿ** (4ä¸ªæ–‡ä»¶)
  - `app/core/personality/models.py` - äººæ ¼æ¨¡å‹
  - `app/core/personality/loader.py` - äººæ ¼åŠ è½½å™¨
  - `app/core/personality/manager.py` - äººæ ¼ç®¡ç†å™¨
  - `app/core/personality/orchestrator.py` - æ ¸å¿ƒç¼–æ’å™¨

#### å¼•æ“æ¨¡å—ï¼ˆEnginesï¼‰
- **AIå¼•æ“** (5ä¸ªæ–‡ä»¶)
  - `app/engines/ai/base.py` - AIå¼•æ“åŸºç±»
  - `app/engines/ai/openai_engine.py` - OpenAIå¼•æ“
  - `app/engines/ai/ollama_engine.py` - Ollamaå¼•æ“
  - `app/engines/ai/factory.py` - AIå¼•æ“å·¥å‚
  - `app/engines/ai/registry.py` - AIå¼•æ“æ³¨å†Œä¸­å¿ƒ

- **è®°å¿†å¼•æ“** (4ä¸ªæ–‡ä»¶)
  - `app/engines/memory/base.py` - è®°å¿†å¼•æ“åŸºç±»
  - `app/engines/memory/chromadb_engine.py` - ChromaDBå¼•æ“
  - `app/engines/memory/manager.py` - è®°å¿†ç®¡ç†å™¨
  - `app/engines/memory/models.py` - è®°å¿†æ¨¡å‹

- **å·¥å…·ç³»ç»Ÿ** (13ä¸ªæ–‡ä»¶)
  - `app/engines/tools/base.py` - å·¥å…·åŸºç±»
  - `app/engines/tools/registry.py` - å·¥å…·æ³¨å†Œä¸­å¿ƒ
  - `app/engines/tools/manager.py` - å·¥å…·ç®¡ç†å™¨
  - `app/engines/tools/builtin/calculator.py` - è®¡ç®—å™¨å·¥å…·
  - `app/engines/tools/builtin/time_tool.py` - æ—¶é—´å·¥å…·
  - `app/engines/tools/builtin/weather_tool.py` - å¤©æ°”å·¥å…·
  - `app/engines/tools/builtin/factory.py` - å†…ç½®å·¥å…·å·¥å‚
  - `app/engines/tools/mcp/client.py` - MCPå®¢æˆ·ç«¯
  - `app/engines/tools/mcp/discovery.py` - MCPå‘ç°
  - `app/engines/tools/mcp/adapters.py` - MCPé€‚é…å™¨

- **è¯­éŸ³å¼•æ“** (15ä¸ªæ–‡ä»¶)
  - `app/engines/voice/stt/base.py` - STTå¼•æ“åŸºç±»
  - `app/engines/voice/stt/openai_stt.py` - OpenAI STTå¼•æ“
  - `app/engines/voice/stt/factory.py` - STTå·¥å‚
  - `app/engines/voice/tts/base.py` - TTSå¼•æ“åŸºç±»
  - `app/engines/voice/tts/openai_tts.py` - OpenAI TTSå¼•æ“
  - `app/engines/voice/tts/factory.py` - TTSå·¥å‚
  - `app/engines/voice/realtime/base.py` - RealTimeå¼•æ“åŸºç±»
  - `app/engines/voice/realtime/openai_realtime.py` - OpenAI RealTimeå¼•æ“
  - `app/engines/voice/realtime/factory.py` - RealTimeå·¥å‚
  - `app/engines/voice/audio/processor.py` - éŸ³é¢‘å¤„ç†å™¨

#### APIæ¥å£æ¨¡å—ï¼ˆAPIï¼‰
- **APIè·¯ç”±** (11ä¸ªæ–‡ä»¶)
  - `app/api/v1/health.py` - å¥åº·æ£€æŸ¥API
  - `app/api/v1/chat.py` - èŠå¤©API
  - `app/api/v1/memory.py` - è®°å¿†API
  - `app/api/v1/users.py` - ç”¨æˆ·API
  - `app/api/v1/auth.py` - è®¤è¯API
  - `app/api/v1/models.py` - æ¨¡å‹API
  - `app/api/v1/personalities.py` - äººæ ¼API
  - `app/api/v1/sessions.py` - ä¼šè¯API
  - `app/api/v1/tools.py` - å·¥å…·API
  - `app/api/v1/audio.py` - éŸ³é¢‘API
  - `app/api/v1/websocket.py` - WebSocket API

- **APIä¾èµ–** (1ä¸ªæ–‡ä»¶)
  - `app/api/deps.py` - APIä¾èµ–æ³¨å…¥

#### æ•°æ®æ¨¡å‹æ¨¡å—ï¼ˆModelsï¼‰
- **æ•°æ®æ¨¡å‹** (4ä¸ªæ–‡ä»¶)
  - `app/models/user.py` - ç”¨æˆ·æ¨¡å‹
  - `app/models/user_profile.py` - ç”¨æˆ·ç”»åƒæ¨¡å‹
  - `app/models/session.py` - ä¼šè¯æ¨¡å‹
  - `app/models/message.py` - æ¶ˆæ¯æ¨¡å‹

#### å·¥å…·æ¨¡å—ï¼ˆUtilsï¼‰
- **å·¥å…·å‡½æ•°** (5ä¸ªæ–‡ä»¶)
  - `app/utils/cache.py` - Redisç¼“å­˜
  - `app/utils/logger.py` - æ—¥å¿—é…ç½®
  - `app/utils/security.py` - å®‰å…¨å·¥å…·ï¼ˆJWTã€å¯†ç å“ˆå¸Œï¼‰
  - `app/utils/query_optimizer.py` - æŸ¥è¯¢ä¼˜åŒ–å™¨
  - `app/utils/config_loader.py` - é…ç½®åŠ è½½å™¨

#### ä¸­é—´ä»¶æ¨¡å—ï¼ˆMiddlewareï¼‰
- **ä¸­é—´ä»¶** (1ä¸ªæ–‡ä»¶)
  - `app/middleware/performance.py` - æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶

### 1.2 æµ‹è¯•æ–‡ä»¶ç»Ÿè®¡

**æ€»è®¡**: çº¦ **77ä¸ªPythonæ–‡ä»¶**éœ€è¦æµ‹è¯•

---

## 2. æµ‹è¯•ä¼˜å…ˆçº§

### 2.1 ä¼˜å…ˆçº§åˆ†ç±»

#### ğŸ”´ P0 - å…³é”®è·¯å¾„ï¼ˆå¿…é¡»æµ‹è¯•ï¼‰
**ä¼˜å…ˆçº§**: æœ€é«˜  
**è¦†ç›–ç‡è¦æ±‚**: â‰¥90%  
**å®Œæˆæ—¶é—´**: ç¬¬1å‘¨

1. **ç”¨æˆ·è®¤è¯ç³»ç»Ÿ** - å®‰å…¨å…³é”®
   - `app/core/user/auth.py` - è®¤è¯æœåŠ¡
   - `app/utils/security.py` - JWTã€å¯†ç å“ˆå¸Œ
   - `app/api/v1/auth.py` - è®¤è¯API
   - `app/api/v1/users.py` - ç”¨æˆ·æ³¨å†Œ/ç™»å½•API

2. **AIå¼•æ“** - æ ¸å¿ƒåŠŸèƒ½
   - `app/engines/ai/openai_engine.py` - OpenAIå¼•æ“
   - `app/engines/ai/factory.py` - AIå¼•æ“å·¥å‚
   - `app/api/v1/chat.py` - èŠå¤©API

3. **æ ¸å¿ƒç¼–æ’å™¨** - æ ¸å¿ƒä¸šåŠ¡æµç¨‹
   - `app/core/personality/orchestrator.py` - æ ¸å¿ƒç¼–æ’å™¨

#### ğŸŸ  P1 - æ ¸å¿ƒåŠŸèƒ½ï¼ˆé‡è¦ï¼‰
**ä¼˜å…ˆçº§**: é«˜  
**è¦†ç›–ç‡è¦æ±‚**: â‰¥85%  
**å®Œæˆæ—¶é—´**: ç¬¬2å‘¨

1. **è®°å¿†ç®¡ç†ç³»ç»Ÿ**
   - `app/engines/memory/chromadb_engine.py` - ChromaDBå¼•æ“
   - `app/engines/memory/manager.py` - è®°å¿†ç®¡ç†å™¨
   - `app/api/v1/memory.py` - è®°å¿†API

2. **å·¥å…·ç³»ç»Ÿ**
   - `app/engines/tools/manager.py` - å·¥å…·ç®¡ç†å™¨
   - `app/engines/tools/builtin/*` - å†…ç½®å·¥å…·
   - `app/api/v1/tools.py` - å·¥å…·API

3. **äººæ ¼ç³»ç»Ÿ**
   - `app/core/personality/manager.py` - äººæ ¼ç®¡ç†å™¨
   - `app/core/personality/loader.py` - äººæ ¼åŠ è½½å™¨
   - `app/api/v1/personalities.py` - äººæ ¼API

4. **ç”¨æˆ·ç®¡ç†**
   - `app/core/user/manager.py` - ç”¨æˆ·ç®¡ç†å™¨
   - `app/core/user/permissions.py` - æƒé™ç®¡ç†
   - `app/api/v1/users.py` - ç”¨æˆ·API

#### ğŸŸ¡ P2 - ä¸šåŠ¡åŠŸèƒ½ï¼ˆä¸­ç­‰ï¼‰
**ä¼˜å…ˆçº§**: ä¸­  
**è¦†ç›–ç‡è¦æ±‚**: â‰¥80%  
**å®Œæˆæ—¶é—´**: ç¬¬3å‘¨

1. **ä¼šè¯ç®¡ç†**
   - `app/models/session.py` - ä¼šè¯æ¨¡å‹
   - `app/models/message.py` - æ¶ˆæ¯æ¨¡å‹
   - `app/api/v1/sessions.py` - ä¼šè¯API

2. **ç”¨æˆ·ç”»åƒ**
   - `app/core/user/profile.py` - ç”¨æˆ·ç”»åƒ
   - `app/core/user/stats.py` - ç”¨æˆ·ç»Ÿè®¡
   - `app/models/user_profile.py` - ç”¨æˆ·ç”»åƒæ¨¡å‹

3. **è¯­éŸ³å¼•æ“**
   - `app/engines/voice/stt/openai_stt.py` - STTå¼•æ“
   - `app/engines/voice/tts/openai_tts.py` - TTSå¼•æ“
   - `app/api/v1/audio.py` - éŸ³é¢‘API

#### ğŸŸ¢ P3 - è¾…åŠ©åŠŸèƒ½ï¼ˆä½ï¼‰
**ä¼˜å…ˆçº§**: ä½  
**è¦†ç›–ç‡è¦æ±‚**: â‰¥70%  
**å®Œæˆæ—¶é—´**: ç¬¬4å‘¨

1. **å·¥å…·å‡½æ•°**
   - `app/utils/cache.py` - Redisç¼“å­˜
   - `app/utils/query_optimizer.py` - æŸ¥è¯¢ä¼˜åŒ–å™¨
   - `app/utils/config_loader.py` - é…ç½®åŠ è½½å™¨

2. **ä¸­é—´ä»¶**
   - `app/middleware/performance.py` - æ€§èƒ½ç›‘æ§

3. **WebSocket**
   - `app/api/v1/websocket.py` - WebSocket API
   - `app/engines/voice/realtime/openai_realtime.py` - RealTimeå¼•æ“

---

## 3. æµ‹è¯•ç”¨ä¾‹è®¾è®¡

### 3.1 ç”¨æˆ·è®¤è¯ç³»ç»Ÿæµ‹è¯•

#### 3.1.1 AuthServiceæµ‹è¯•
**æ–‡ä»¶**: `tests/test_core/test_user/test_auth.py`

```python
class TestAuthService:
    """æµ‹è¯•è®¤è¯æœåŠ¡"""
    
    # å¯†ç å“ˆå¸Œæµ‹è¯•
    def test_hash_password()
    def test_verify_password_success()
    def test_verify_password_failure()
    
    # JWTä»¤ç‰Œæµ‹è¯•
    def test_create_access_token()
    def test_create_refresh_token()
    def test_verify_token_success()
    def test_verify_token_expired()
    def test_verify_token_invalid()
    
    # ç”¨æˆ·è®¤è¯æµ‹è¯•
    def test_authenticate_user_success()
    def test_authenticate_user_not_found()
    def test_authenticate_user_wrong_password()
    def test_authenticate_user_inactive()
    
    # ä»ä»¤ç‰Œè·å–ç”¨æˆ·æµ‹è¯•
    def test_get_current_user_from_token_success()
    def test_get_current_user_from_token_invalid()
    def test_get_current_user_from_token_user_not_found()
```

#### 3.1.2 Securityå·¥å…·æµ‹è¯•
**æ–‡ä»¶**: `tests/test_utils/test_security.py`

```python
class TestSecurityUtils:
    """æµ‹è¯•å®‰å…¨å·¥å…·"""
    
    def test_hash_password()
    def test_verify_password()
    def test_create_access_token()
    def test_create_refresh_token()
    def test_decode_token()
    def test_decode_token_expired()
    def test_decode_token_invalid()
```

#### 3.1.3 è®¤è¯APIæµ‹è¯•
**æ–‡ä»¶**: `tests/test_api/test_auth.py`

```python
class TestAuthAPI:
    """æµ‹è¯•è®¤è¯API"""
    
    @pytest.mark.asyncio
    async def test_refresh_token_success()
    async def test_refresh_token_invalid()
    async def test_refresh_token_expired()
    async def test_refresh_token_missing()
```

### 3.2 AIå¼•æ“æµ‹è¯•

#### 3.2.1 OpenAIå¼•æ“æµ‹è¯•
**æ–‡ä»¶**: `tests/test_engines/test_ai/test_openai_engine.py`

```python
class TestOpenAIEngine:
    """æµ‹è¯•OpenAIå¼•æ“"""
    
    @pytest.mark.asyncio
    async def test_chat_completion_success(mock_openai_client)
    async def test_chat_completion_stream(mock_openai_client)
    async def test_chat_completion_with_tools(mock_openai_client)
    async def test_chat_completion_api_error(mock_openai_client)
    async def test_chat_completion_timeout(mock_openai_client)
    async def test_chat_completion_invalid_model(mock_openai_client)
    
    def test_engine_initialization()
    def test_health_check_success()
    def test_health_check_failure()
```

#### 3.2.2 AIå¼•æ“å·¥å‚æµ‹è¯•
**æ–‡ä»¶**: `tests/test_engines/test_ai/test_ai_factory.py`

```python
class TestAIEngineFactory:
    """æµ‹è¯•AIå¼•æ“å·¥å‚"""
    
    def test_create_openai_engine()
    def test_create_ollama_engine()
    def test_create_engine_invalid_type()
    def test_create_engine_from_config()
    def test_list_available_engines()
```

### 3.3 è®°å¿†ç®¡ç†ç³»ç»Ÿæµ‹è¯•

#### 3.3.1 ChromaDBå¼•æ“æµ‹è¯•
**æ–‡ä»¶**: `tests/test_engines/test_memory/test_chromadb_engine.py`

```python
class TestChromaDBEngine:
    """æµ‹è¯•ChromaDBå¼•æ“"""
    
    @pytest.fixture
    def chromadb_engine(temp_chromadb_dir)
    
    @pytest.mark.asyncio
    async def test_add_memory_user(chromadb_engine)
    async def test_add_memory_assistant(chromadb_engine)
    async def test_search_memories(chromadb_engine)
    async def test_search_memories_with_session(chromadb_engine)
    async def test_search_memories_with_type(chromadb_engine)
    async def test_delete_memory(chromadb_engine)
    async def test_delete_session_memories(chromadb_engine)
    async def test_get_memory_stats(chromadb_engine)
    async def test_health_check(chromadb_engine)
```

#### 3.3.2 è®°å¿†ç®¡ç†å™¨æµ‹è¯•
**æ–‡ä»¶**: `tests/test_engines/test_memory/test_memory_manager.py`

```python
class TestMemoryManager:
    """æµ‹è¯•è®°å¿†ç®¡ç†å™¨"""
    
    @pytest.fixture
    def memory_manager(chromadb_engine)
    
    @pytest.mark.asyncio
    async def test_add_memory(memory_manager)
    async def test_add_memory_async_save(memory_manager)
    async def test_search_memories(memory_manager)
    async def test_search_memories_cached(memory_manager)
    async def test_delete_memory(memory_manager)
    async def test_delete_session_memories(memory_manager)
    async def test_get_memory_stats(memory_manager)
```

### 3.4 å·¥å…·ç³»ç»Ÿæµ‹è¯•

#### 3.4.1 å·¥å…·ç®¡ç†å™¨æµ‹è¯•
**æ–‡ä»¶**: `tests/test_engines/test_tools/test_tool_manager.py`

```python
class TestToolManager:
    """æµ‹è¯•å·¥å…·ç®¡ç†å™¨"""
    
    @pytest.fixture
    def tool_manager()
    
    @pytest.mark.asyncio
    async def test_execute_tool_success(tool_manager)
    async def test_execute_tool_timeout(tool_manager)
    async def test_execute_tool_invalid_parameters(tool_manager)
    async def test_execute_tools_concurrent(tool_manager)
    async def test_get_available_tools(tool_manager)
    async def test_get_tools_for_openai(tool_manager)
    async def test_health_check(tool_manager)
```

#### 3.4.2 å†…ç½®å·¥å…·æµ‹è¯•
**æ–‡ä»¶**: `tests/test_engines/test_tools/test_builtin_tools.py`

```python
class TestCalculatorTool:
    """æµ‹è¯•è®¡ç®—å™¨å·¥å…·"""
    
    @pytest.mark.asyncio
    async def test_calculate_addition()
    async def test_calculate_subtraction()
    async def test_calculate_multiplication()
    async def test_calculate_division()
    async def test_calculate_invalid_expression()
    async def test_to_openai_function()

class TestTimeTool:
    """æµ‹è¯•æ—¶é—´å·¥å…·"""
    
    @pytest.mark.asyncio
    async def test_get_current_time()
    async def test_get_current_time_with_timezone()
    async def test_get_current_time_with_format()
    async def test_to_openai_function()

class TestWeatherTool:
    """æµ‹è¯•å¤©æ°”å·¥å…·"""
    
    @pytest.mark.asyncio
    async def test_get_weather_success(mock_weather_api)
    async def test_get_weather_invalid_city(mock_weather_api)
    async def test_get_weather_api_error(mock_weather_api)
    async def test_to_openai_function()
```

### 3.5 äººæ ¼ç³»ç»Ÿæµ‹è¯•

#### 3.5.1 äººæ ¼ç®¡ç†å™¨æµ‹è¯•
**æ–‡ä»¶**: `tests/test_core/test_personality/test_personality_manager.py`

```python
class TestPersonalityManager:
    """æµ‹è¯•äººæ ¼ç®¡ç†å™¨"""
    
    @pytest.fixture
    def personality_manager()
    
    def test_get_personality_success(personality_manager)
    def test_get_personality_not_found(personality_manager)
    def test_list_personalities(personality_manager)
    def test_create_personality(personality_manager)
    def test_update_personality(personality_manager)
    def test_delete_personality(personality_manager)
    def test_reload_personality(personality_manager)
```

#### 3.5.2 æ ¸å¿ƒç¼–æ’å™¨æµ‹è¯•
**æ–‡ä»¶**: `tests/test_core/test_personality/test_orchestrator.py`

```python
class TestOrchestrator:
    """æµ‹è¯•æ ¸å¿ƒç¼–æ’å™¨"""
    
    @pytest.fixture
    def orchestrator(mock_personality_manager, mock_memory_manager, mock_tool_manager)
    
    @pytest.mark.asyncio
    async def test_process_chat_request_basic(orchestrator)
    async def test_process_chat_request_with_memory(orchestrator)
    async def test_process_chat_request_with_tools(orchestrator)
    async def test_process_chat_request_stream(orchestrator)
    async def test_process_chat_request_error_handling(orchestrator)
```

### 3.6 APIæ¥å£æµ‹è¯•

#### 3.6.1 èŠå¤©APIæµ‹è¯•
**æ–‡ä»¶**: `tests/test_api/test_chat.py`

```python
class TestChatAPI:
    """æµ‹è¯•èŠå¤©API"""
    
    @pytest.mark.asyncio
    async def test_create_chat_completion_success(async_client, mock_openai)
    async def test_create_chat_completion_stream(async_client, mock_openai)
    async def test_create_chat_completion_with_personality(async_client)
    async def test_create_chat_completion_invalid_request(async_client)
    async def test_list_engines(async_client)
    async def test_list_models(async_client)
```

#### 3.6.2 ç”¨æˆ·APIæµ‹è¯•
**æ–‡ä»¶**: `tests/test_api/test_users.py`

```python
class TestUsersAPI:
    """æµ‹è¯•ç”¨æˆ·API"""
    
    @pytest.mark.asyncio
    async def test_register_user_success(async_client, sync_db_session)
    async def test_register_user_duplicate(async_client, sync_db_session)
    async def test_register_user_invalid_data(async_client)
    async def test_login_success(async_client, sync_db_session, test_user)
    async def test_login_invalid_credentials(async_client, sync_db_session)
    async def test_get_current_user(async_client, test_user, auth_token)
    async def test_update_user_preferences(async_client, test_user, auth_token)
    async def test_get_user_profile(async_client, test_user, auth_token)
    async def test_get_user_stats(async_client, test_user, auth_token)
```

#### 3.6.3 è®°å¿†APIæµ‹è¯•
**æ–‡ä»¶**: `tests/test_api/test_memory.py`

```python
class TestMemoryAPI:
    """æµ‹è¯•è®°å¿†API"""
    
    @pytest.mark.asyncio
    async def test_create_memory(async_client, test_user, auth_token)
    async def test_search_memories(async_client, test_user, auth_token)
    async def test_delete_memory(async_client, test_user, auth_token)
    async def test_delete_session_memories(async_client, test_user, auth_token)
    async def test_get_memory_stats(async_client, test_user, auth_token)
```

### 3.7 æ•°æ®æ¨¡å‹æµ‹è¯•

#### 3.7.1 ç”¨æˆ·æ¨¡å‹æµ‹è¯•
**æ–‡ä»¶**: `tests/test_models/test_user.py`

```python
class TestUserModel:
    """æµ‹è¯•ç”¨æˆ·æ¨¡å‹"""
    
    def test_user_creation()
    def test_user_properties()
    def test_user_update_last_login()
    def test_user_get_preferences()
    def test_user_update_preferences()
    def test_user_constraints()
```

#### 3.7.2 ä¼šè¯æ¨¡å‹æµ‹è¯•
**æ–‡ä»¶**: `tests/test_models/test_session.py`

```python
class TestSessionModel:
    """æµ‹è¯•ä¼šè¯æ¨¡å‹"""
    
    def test_session_creation()
    def test_session_to_dict()
    def test_session_relationships()
```

---

## 4. æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

### 4.1 è¦†ç›–ç‡è¦æ±‚

| æ¨¡å—ç±»å‹ | è¦†ç›–ç‡è¦æ±‚ | ä¼˜å…ˆçº§ |
|---------|-----------|--------|
| **æ ¸å¿ƒä¸šåŠ¡é€»è¾‘** | â‰¥90% | P0 |
| **AIå¼•æ“** | â‰¥85% | P0 |
| **è®°å¿†ç®¡ç†** | â‰¥85% | P1 |
| **å·¥å…·ç³»ç»Ÿ** | â‰¥85% | P1 |
| **äººæ ¼ç³»ç»Ÿ** | â‰¥85% | P1 |
| **ç”¨æˆ·ç®¡ç†** | â‰¥85% | P1 |
| **APIæ¥å£** | â‰¥80% | P1 |
| **æ•°æ®æ¨¡å‹** | â‰¥80% | P2 |
| **å·¥å…·å‡½æ•°** | â‰¥90% | P2 |
| **ä¸­é—´ä»¶** | â‰¥70% | P3 |
| **è¯­éŸ³å¼•æ“** | â‰¥75% | P2 |
| **WebSocket** | â‰¥70% | P3 |

### 4.2 è¦†ç›–ç‡ç»Ÿè®¡

**æ€»ä½“ç›®æ ‡**: â‰¥80%  
**æ ¸å¿ƒæ¨¡å—ç›®æ ‡**: â‰¥85%  
**å…³é”®è·¯å¾„ç›®æ ‡**: â‰¥90%

---

## 5. æµ‹è¯•æ‰§è¡Œè®¡åˆ’

### 5.1 æ‰§è¡Œæ—¶é—´è¡¨

#### ç¬¬1å‘¨ï¼šP0å…³é”®è·¯å¾„æµ‹è¯•
**ç›®æ ‡**: å®Œæˆå…³é”®è·¯å¾„æµ‹è¯•ï¼Œè¦†ç›–ç‡â‰¥90%

**ä»»åŠ¡æ¸…å•**:
- [ ] ç”¨æˆ·è®¤è¯ç³»ç»Ÿæµ‹è¯•ï¼ˆAuthServiceã€Securityã€Auth APIï¼‰
- [ ] AIå¼•æ“æµ‹è¯•ï¼ˆOpenAIEngineã€AIEngineFactoryï¼‰
- [ ] æ ¸å¿ƒç¼–æ’å™¨æµ‹è¯•ï¼ˆOrchestratorï¼‰
- [ ] èŠå¤©APIæµ‹è¯•ï¼ˆChat APIï¼‰

**é¢„è®¡å·¥ä½œé‡**: 20-30å°æ—¶

#### ç¬¬2å‘¨ï¼šP1æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
**ç›®æ ‡**: å®Œæˆæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼Œè¦†ç›–ç‡â‰¥85%

**ä»»åŠ¡æ¸…å•**:
- [ ] è®°å¿†ç®¡ç†ç³»ç»Ÿæµ‹è¯•ï¼ˆChromaDBEngineã€MemoryManagerã€Memory APIï¼‰
- [ ] å·¥å…·ç³»ç»Ÿæµ‹è¯•ï¼ˆToolManagerã€å†…ç½®å·¥å…·ã€Tools APIï¼‰
- [ ] äººæ ¼ç³»ç»Ÿæµ‹è¯•ï¼ˆPersonalityManagerã€Personalities APIï¼‰
- [ ] ç”¨æˆ·ç®¡ç†æµ‹è¯•ï¼ˆUserManagerã€Permissionsã€Users APIï¼‰

**é¢„è®¡å·¥ä½œé‡**: 25-35å°æ—¶

#### ç¬¬3å‘¨ï¼šP2ä¸šåŠ¡åŠŸèƒ½æµ‹è¯•
**ç›®æ ‡**: å®Œæˆä¸šåŠ¡åŠŸèƒ½æµ‹è¯•ï¼Œè¦†ç›–ç‡â‰¥80%

**ä»»åŠ¡æ¸…å•**:
- [ ] ä¼šè¯ç®¡ç†æµ‹è¯•ï¼ˆSessionã€Messageæ¨¡å‹ã€Sessions APIï¼‰
- [ ] ç”¨æˆ·ç”»åƒæµ‹è¯•ï¼ˆUserProfileã€ProfileManagerï¼‰
- [ ] è¯­éŸ³å¼•æ“æµ‹è¯•ï¼ˆSTTã€TTSã€Audio APIï¼‰
- [ ] æ¨¡å‹APIæµ‹è¯•ï¼ˆModels APIï¼‰

**é¢„è®¡å·¥ä½œé‡**: 20-30å°æ—¶

#### ç¬¬4å‘¨ï¼šP3è¾…åŠ©åŠŸèƒ½æµ‹è¯•
**ç›®æ ‡**: å®Œæˆè¾…åŠ©åŠŸèƒ½æµ‹è¯•ï¼Œè¦†ç›–ç‡â‰¥70%

**ä»»åŠ¡æ¸…å•**:
- [ ] å·¥å…·å‡½æ•°æµ‹è¯•ï¼ˆCacheã€QueryOptimizerã€ConfigLoaderï¼‰
- [ ] ä¸­é—´ä»¶æµ‹è¯•ï¼ˆPerformanceMiddlewareï¼‰
- [ ] WebSocketæµ‹è¯•ï¼ˆWebSocket APIã€RealTimeå¼•æ“ï¼‰
- [ ] é›†æˆæµ‹è¯•

**é¢„è®¡å·¥ä½œé‡**: 15-25å°æ—¶

### 5.2 æµ‹è¯•æ‰§è¡Œå‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•
pytest tests/test_core/test_user/ -v
pytest tests/test_engines/test_ai/ -v
pytest tests/test_api/ -v

# è¿è¡Œå¹¶æŸ¥çœ‹è¦†ç›–ç‡
pytest --cov=app --cov-report=html
open htmlcov/index.html

# è¿è¡Œç‰¹å®šä¼˜å…ˆçº§çš„æµ‹è¯•
pytest -m "unit" -v  # P0å…³é”®è·¯å¾„
pytest -m "integration" -v  # P1æ ¸å¿ƒåŠŸèƒ½

# è¿è¡Œå¹¶æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
pytest -v -s

# è¿è¡Œå¹¶æ˜¾ç¤ºè¦†ç›–ç‡
pytest --cov=app --cov-report=term-missing
```

---

## 6. æµ‹è¯•æ•°æ®ç®¡ç†

### 6.1 æµ‹è¯•æ•°æ®åº“

**é…ç½®**: 
- **åœ°å€**: 192.168.66.10
- **ç«¯å£**: 5432
- **æ•°æ®åº“**: `cozychat_test`
- **ç”¨æˆ·å**: cozychat
- **å¯†ç **: passw0rd

**ä½¿ç”¨æ–¹å¼**:
- æ¯ä¸ªæµ‹è¯•å‡½æ•°è¿è¡Œå‰è‡ªåŠ¨åˆ›å»ºè¡¨
- æ¯ä¸ªæµ‹è¯•å‡½æ•°è¿è¡Œåè‡ªåŠ¨æ¸…ç†ï¼ˆå¯é€‰ï¼‰
- ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“ï¼Œä¸å½±å“ç”Ÿäº§æ•°æ®

### 6.2 æµ‹è¯•Fixtures

**æ•°æ®åº“Fixtures**:
- `db_session` - å¼‚æ­¥æ•°æ®åº“ä¼šè¯
- `sync_db_session` - åŒæ­¥æ•°æ®åº“ä¼šè¯

**Mock Fixtures**:
- `mock_openai_client` - Mock OpenAIå®¢æˆ·ç«¯
- `mock_chromadb` - Mock ChromaDBå®¢æˆ·ç«¯
- `mock_qdrant_client` - Mock Qdrantå®¢æˆ·ç«¯
- `mock_redis` - Mock Rediså®¢æˆ·ç«¯

**æµ‹è¯•æ•°æ®Fixtures**:
- `test_user_data` - æµ‹è¯•ç”¨æˆ·æ•°æ®
- `test_personality_data` - æµ‹è¯•äººæ ¼æ•°æ®
- `temp_chromadb_dir` - ä¸´æ—¶ChromaDBç›®å½•

### 6.3 æµ‹è¯•æ•°æ®æ¸…ç†

**ç­–ç•¥**:
- **å•å…ƒæµ‹è¯•**: æ¯ä¸ªæµ‹è¯•å‡½æ•°è¿è¡Œåæ¸…ç†æ•°æ®
- **é›†æˆæµ‹è¯•**: æ¯ä¸ªæµ‹è¯•ç±»è¿è¡Œåæ¸…ç†æ•°æ®
- **è°ƒè¯•æ¨¡å¼**: å¯ä¿ç•™æµ‹è¯•æ•°æ®ç”¨äºè°ƒè¯•

---

## 7. Mockç­–ç•¥

### 7.1 å¤–éƒ¨æœåŠ¡Mock

#### OpenAI API Mock
```python
@pytest.fixture
def mock_openai_client(mocker):
    """Mock OpenAIå®¢æˆ·ç«¯"""
    mock = mocker.Mock()
    mock.chat.completions.create = AsyncMock(return_value=...)
    return mock
```

#### ChromaDB Mock
```python
@pytest.fixture
def mock_chromadb(mocker):
    """Mock ChromaDBå®¢æˆ·ç«¯"""
    mock_client = mocker.Mock()
    mock_collection = mocker.Mock()
    mock_collection.query = mocker.Mock(return_value=...)
    return mock_client, mock_collection
```

#### Redis Mock
```python
@pytest.fixture
def mock_redis(mocker):
    """Mock Rediså®¢æˆ·ç«¯"""
    mock = mocker.Mock()
    mock.get = mocker.Mock(return_value=None)
    mock.set = mocker.Mock(return_value=True)
    return mock
```

### 7.2 æ•°æ®åº“Mock

**ç­–ç•¥**: 
- ä½¿ç”¨æµ‹è¯•æ•°æ®åº“ï¼ˆçœŸå®æ•°æ®åº“ï¼‰
- æ¯ä¸ªæµ‹è¯•å‡½æ•°è¿è¡Œå‰åˆ›å»ºè¡¨
- æ¯ä¸ªæµ‹è¯•å‡½æ•°è¿è¡Œåæ¸…ç†æ•°æ®

### 7.3 ä¾èµ–æ³¨å…¥Mock

**ç­–ç•¥**:
- ä½¿ç”¨FastAPIçš„`dependency_overrides`æœºåˆ¶
- åœ¨æµ‹è¯•ä¸­è¦†ç›–ä¾èµ–é¡¹
- æµ‹è¯•åè‡ªåŠ¨æ¸…ç†è¦†ç›–

---

## 8. æµ‹è¯•å·¥å…·å’Œç¯å¢ƒ

### 8.1 æµ‹è¯•æ¡†æ¶

- **pytest 8.4.2** - æµ‹è¯•æ¡†æ¶
- **pytest-asyncio 0.23.3** - å¼‚æ­¥æµ‹è¯•æ”¯æŒ
- **pytest-cov 4.1.0** - è¦†ç›–ç‡ç»Ÿè®¡
- **pytest-mock 3.12.0** - Mockæ”¯æŒ
- **httpx 0.28.1** - HTTPæµ‹è¯•å®¢æˆ·ç«¯

### 8.2 æµ‹è¯•ç¯å¢ƒ

**æ•°æ®åº“**:
- PostgreSQLæµ‹è¯•æ•°æ®åº“: `cozychat_test`
- åœ°å€: 192.168.66.10:5432

**å¤–éƒ¨æœåŠ¡**:
- Redis: ä½¿ç”¨Mockï¼ˆæµ‹è¯•æ—¶ï¼‰
- ChromaDB: ä½¿ç”¨ä¸´æ—¶ç›®å½•
- Qdrant: ä½¿ç”¨Mockï¼ˆæµ‹è¯•æ—¶ï¼‰
- OpenAI: ä½¿ç”¨Mockï¼ˆå¿…é¡»ï¼‰

### 8.3 æµ‹è¯•é…ç½®

**pytest.ini**:
- è¦†ç›–ç‡ç›®æ ‡: â‰¥60%ï¼ˆæµ‹è¯•é˜¶æ®µï¼‰
- å¼‚æ­¥æµ‹è¯•æ”¯æŒ: å·²å¯ç”¨
- æµ‹è¯•æ ‡è®°: unit, integration, asyncio, slow

**conftest.py**:
- æ•°æ®åº“ä¼šè¯fixtures
- Mock fixtures
- æµ‹è¯•æ•°æ®fixtures

---

## 9. æµ‹è¯•æ£€æŸ¥æ¸…å•

### 9.1 æµ‹è¯•ç¼–å†™æ£€æŸ¥æ¸…å•

- [ ] æµ‹è¯•æ–‡ä»¶å‘½åè§„èŒƒï¼ˆ`test_*.py`ï¼‰
- [ ] æµ‹è¯•ç±»å‘½åè§„èŒƒï¼ˆ`Test*`ï¼‰
- [ ] æµ‹è¯•å‡½æ•°å‘½åè§„èŒƒï¼ˆ`test_*`ï¼‰
- [ ] ä½¿ç”¨é€‚å½“çš„fixtures
- [ ] ä½¿ç”¨Mockéš”ç¦»å¤–éƒ¨ä¾èµ–
- [ ] æµ‹è¯•æˆåŠŸåœºæ™¯
- [ ] æµ‹è¯•å¤±è´¥åœºæ™¯
- [ ] æµ‹è¯•è¾¹ç•Œæ¡ä»¶
- [ ] æµ‹è¯•é”™è¯¯å¤„ç†
- [ ] æµ‹è¯•å¼‚æ­¥å‡½æ•°ä½¿ç”¨`@pytest.mark.asyncio`

### 9.2 æµ‹è¯•æ‰§è¡Œæ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] è¦†ç›–ç‡è¾¾æ ‡
- [ ] æ²¡æœ‰æµ‹è¯•è­¦å‘Š
- [ ] æµ‹è¯•æ‰§è¡Œæ—¶é—´åˆç†
- [ ] æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ

---

## 10. æµ‹è¯•æŠ¥å‘Š

### 10.1 è¦†ç›–ç‡æŠ¥å‘Š

**ç”Ÿæˆå‘½ä»¤**:
```bash
pytest --cov=app --cov-report=html
open htmlcov/index.html
```

**æŠ¥å‘Šå†…å®¹**:
- æ€»ä½“è¦†ç›–ç‡
- æ¨¡å—è¦†ç›–ç‡
- æ–‡ä»¶è¦†ç›–ç‡
- æœªè¦†ç›–ä»£ç è¡Œ

### 10.2 æµ‹è¯•æ‰§è¡ŒæŠ¥å‘Š

**ç”Ÿæˆå‘½ä»¤**:
```bash
pytest --junitxml=test-results.xml
pytest --html=test-report.html --self-contained-html
```

**æŠ¥å‘Šå†…å®¹**:
- æµ‹è¯•æ‰§è¡Œç»“æœ
- æµ‹è¯•æ‰§è¡Œæ—¶é—´
- å¤±è´¥æµ‹è¯•è¯¦æƒ…
- æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯

---

## 11. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### 11.1 ç«‹å³è¡ŒåŠ¨ï¼ˆä»Šå¤©ï¼‰

1. **åˆ›å»ºæµ‹è¯•æ•°æ®åº“**
   ```sql
   CREATE DATABASE cozychat_test;
   ```

2. **éªŒè¯æµ‹è¯•åŸºç¡€è®¾æ–½**
   ```bash
   pytest tests/test_infrastructure.py -v
   ```

3. **å¼€å§‹ç¼–å†™P0æµ‹è¯•**
   - ç”¨æˆ·è®¤è¯ç³»ç»Ÿæµ‹è¯•
   - AIå¼•æ“æµ‹è¯•

### 11.2 çŸ­æœŸè¡ŒåŠ¨ï¼ˆæœ¬å‘¨ï¼‰

1. **å®ŒæˆP0å…³é”®è·¯å¾„æµ‹è¯•**
   - ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
   - AIå¼•æ“
   - æ ¸å¿ƒç¼–æ’å™¨
   - èŠå¤©API

2. **è¾¾åˆ°è¦†ç›–ç‡ç›®æ ‡**
   - P0æ¨¡å—: â‰¥90%
   - æ€»ä½“: â‰¥60%

### 11.3 é•¿æœŸè¡ŒåŠ¨ï¼ˆ1ä¸ªæœˆï¼‰

1. **å®Œæˆæ‰€æœ‰æµ‹è¯•**
   - P0ã€P1ã€P2ã€P3æ‰€æœ‰æ¨¡å—

2. **è¾¾åˆ°æ€»ä½“è¦†ç›–ç‡ç›®æ ‡**
   - æ€»ä½“: â‰¥80%
   - æ ¸å¿ƒæ¨¡å—: â‰¥85%

3. **å»ºç«‹CI/CDæµ‹è¯•æµç¨‹**
   - è‡ªåŠ¨åŒ–æµ‹è¯•æ‰§è¡Œ
   - è¦†ç›–ç‡æŠ¥å‘Š
   - æµ‹è¯•ç»“æœé€šçŸ¥

---

## 12. æµ‹è¯•è®¡åˆ’æ€»ç»“

### 12.1 æµ‹è¯•èŒƒå›´

- **æ€»æ–‡ä»¶æ•°**: çº¦77ä¸ªPythonæ–‡ä»¶
- **æµ‹è¯•æ–‡ä»¶æ•°**: çº¦50-60ä¸ªæµ‹è¯•æ–‡ä»¶
- **æµ‹è¯•ç”¨ä¾‹æ•°**: çº¦300-400ä¸ªæµ‹è¯•ç”¨ä¾‹

### 12.2 æµ‹è¯•ä¼˜å…ˆçº§

- **P0å…³é”®è·¯å¾„**: 4ä¸ªæ¨¡å—ï¼Œçº¦50ä¸ªæµ‹è¯•ç”¨ä¾‹
- **P1æ ¸å¿ƒåŠŸèƒ½**: 8ä¸ªæ¨¡å—ï¼Œçº¦150ä¸ªæµ‹è¯•ç”¨ä¾‹
- **P2ä¸šåŠ¡åŠŸèƒ½**: 6ä¸ªæ¨¡å—ï¼Œçº¦100ä¸ªæµ‹è¯•ç”¨ä¾‹
- **P3è¾…åŠ©åŠŸèƒ½**: 4ä¸ªæ¨¡å—ï¼Œçº¦50ä¸ªæµ‹è¯•ç”¨ä¾‹

### 12.3 é¢„è®¡å·¥ä½œé‡

- **P0å…³é”®è·¯å¾„**: 20-30å°æ—¶
- **P1æ ¸å¿ƒåŠŸèƒ½**: 25-35å°æ—¶
- **P2ä¸šåŠ¡åŠŸèƒ½**: 20-30å°æ—¶
- **P3è¾…åŠ©åŠŸèƒ½**: 15-25å°æ—¶
- **æ€»è®¡**: 80-120å°æ—¶

### 12.4 è¦†ç›–ç‡ç›®æ ‡

- **æ€»ä½“ç›®æ ‡**: â‰¥80%
- **æ ¸å¿ƒæ¨¡å—**: â‰¥85%
- **å…³é”®è·¯å¾„**: â‰¥90%

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-07

