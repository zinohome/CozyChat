# CozyChat å‰ç«¯æµ‹è¯•å¼€å‘æŒ‡å—

> **æ–‡æ¡£ä½ç½®**: `docs/21-å‰ç«¯æµ‹è¯•å¼€å‘æŒ‡å—.md`  
> **åˆ›å»ºæ—¥æœŸ**: 2025-01-27  
> **æœ€åæ›´æ–°**: 2025-01-27

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•ä¸ºCozyChatå‰ç«¯é¡¹ç›®ç¼–å†™å’Œç»´æŠ¤æµ‹è¯•ã€‚

## ğŸ¯ æµ‹è¯•ç›®æ ‡

- **è¦†ç›–ç‡ç›®æ ‡**: â‰¥60%ï¼ˆæ ¸å¿ƒåŠŸèƒ½â‰¥80%ï¼‰
- **æµ‹è¯•ç±»å‹**: å•å…ƒæµ‹è¯•ã€ç»„ä»¶æµ‹è¯•ã€Hookæµ‹è¯•ã€é›†æˆæµ‹è¯•
- **æµ‹è¯•æ¡†æ¶**: Vitest + React Testing Library

## ğŸ› ï¸ æµ‹è¯•åŸºç¡€è®¾æ–½

### å·²é…ç½®çš„å·¥å…·

- âœ… **Vitest**: æµ‹è¯•è¿è¡Œå™¨
- âœ… **React Testing Library**: ç»„ä»¶æµ‹è¯•
- âœ… **jsdom**: DOMç¯å¢ƒæ¨¡æ‹Ÿ
- âœ… **@testing-library/jest-dom**: DOMæ–­è¨€
- âœ… **@testing-library/user-event**: ç”¨æˆ·äº¤äº’æ¨¡æ‹Ÿ

### æµ‹è¯•é…ç½®æ–‡ä»¶

- `vitest.config.ts`: Vitesté…ç½®
- `src/test/setup.ts`: æµ‹è¯•ç¯å¢ƒè®¾ç½®
- `src/test/utils.tsx`: æµ‹è¯•å·¥å…·å‡½æ•°

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»„ç»‡

```
frontend/src/
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ setup.ts              # æµ‹è¯•ç¯å¢ƒè®¾ç½®
â”‚   â”œâ”€â”€ utils.tsx             # æµ‹è¯•å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ mocks/
â”‚       â””â”€â”€ handlers.ts        # MSW Mock handlers
â”œâ”€â”€ components/
â”‚   â””â”€â”€ **/*.test.tsx          # ç»„ä»¶æµ‹è¯•
â”œâ”€â”€ features/
â”‚   â””â”€â”€ **/
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â””â”€â”€ **/*.test.tsx  # åŠŸèƒ½ç»„ä»¶æµ‹è¯•
â”‚       â””â”€â”€ hooks/
â”‚           â””â”€â”€ **/*.test.ts  # Hookæµ‹è¯•
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ **/*.test.ts           # å…¨å±€Hookæµ‹è¯•
â”œâ”€â”€ services/
â”‚   â””â”€â”€ **/*.test.ts           # æœåŠ¡æµ‹è¯•
â””â”€â”€ utils/
    â””â”€â”€ **/*.test.ts            # å·¥å…·å‡½æ•°æµ‹è¯•
```

## ğŸ“ ç¼–å†™æµ‹è¯•

### 1. ç»„ä»¶æµ‹è¯•

**ç¤ºä¾‹**: `MessageBubble.test.tsx`

```typescript
import { describe, it, expect } from 'vitest';
import { render, screen } from '@/test/utils';
import { MessageBubble } from './MessageBubble';

describe('MessageBubble', () => {
  it('åº”è¯¥æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯', () => {
    render(
      <MessageBubble
        role="user"
        content="Hello, AI!"
        timestamp={new Date()}
      />
    );

    expect(screen.getByText('Hello, AI!')).toBeInTheDocument();
  });

  it('åº”è¯¥æ¸²æŸ“AIæ¶ˆæ¯', () => {
    render(
      <MessageBubble
        role="assistant"
        content="Hello, User!"
        timestamp={new Date()}
      />
    );

    expect(screen.getByText('Hello, User!')).toBeInTheDocument();
  });
});
```

### 2. Hookæµ‹è¯•

**ç¤ºä¾‹**: `useAuth.test.ts`

```typescript
import { describe, it, expect, vi } from 'vitest';
import { renderHook, waitFor } from '@testing-library/react';
import { useAuth } from './useAuth';
import { authApi } from '@/services/auth';

vi.mock('@/services/auth');

describe('useAuth', () => {
  it('åº”è¯¥ç™»å½•ç”¨æˆ·', async () => {
    const mockLogin = vi.mocked(authApi.login);
    mockLogin.mockResolvedValue({
      access_token: 'token',
      user: { id: '1', username: 'test' },
    });

    const { result } = renderHook(() => useAuth());
    await result.current.login({ username: 'test', password: 'pass' });

    expect(mockLogin).toHaveBeenCalled();
  });
});
```

### 3. æœåŠ¡æµ‹è¯•

**ç¤ºä¾‹**: `api.test.ts`

```typescript
import { describe, it, expect, vi } from 'vitest';
import { apiClient } from './api';

describe('apiClient', () => {
  it('åº”è¯¥å‘é€GETè¯·æ±‚', async () => {
    const response = await apiClient.get('/test');
    expect(response).toBeDefined();
  });
});
```

## ğŸ§ª æµ‹è¯•å‘½ä»¤

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œæµ‹è¯•ï¼ˆå•æ¬¡ï¼Œä¸ç›‘å¬ï¼‰
pnpm test --run

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pnpm test MessageBubble

# ç›‘å¬æ¨¡å¼
pnpm test --watch
```

### æµ‹è¯•è¦†ç›–ç‡

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pnpm test:coverage

# æŸ¥çœ‹HTMLæŠ¥å‘Š
open frontend/coverage/index.html
```

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

### æŒ‰æ¨¡å—åˆ†ç±»

| æ¨¡å— | è¦†ç›–ç‡è¦æ±‚ | å½“å‰çŠ¶æ€ |
|------|-----------|---------|
| å·¥å…·å‡½æ•° | â‰¥90% | å¾…ç»Ÿè®¡ |
| Hooks | â‰¥80% | å¾…ç»Ÿè®¡ |
| ç»„ä»¶ | â‰¥60% | å¾…ç»Ÿè®¡ |
| æœåŠ¡ | â‰¥80% | å¾…ç»Ÿè®¡ |
| **æ€»ä½“** | **â‰¥60%** | **0%** |

### ä¼˜å…ˆçº§

1. **P0 - å…³é”®è·¯å¾„**:
   - è®¤è¯Hook (`useAuth`)
   - èŠå¤©Hook (`useStreamChat`)
   - æ ¸å¿ƒç»„ä»¶ (`ChatContainer`, `MessageBubble`)

2. **P1 - é‡è¦åŠŸèƒ½**:
   - ä¼šè¯ç®¡ç† (`useSessions`)
   - APIæœåŠ¡å±‚
   - çŠ¶æ€ç®¡ç† (Zustand slices)

3. **P2 - è¾…åŠ©åŠŸèƒ½**:
   - å·¥å…·å‡½æ•°
   - UIç»„ä»¶
   - å·¥å…·ç±»

## ğŸ”§ Mockå’Œæµ‹è¯•å·¥å…·

### ä½¿ç”¨æµ‹è¯•å·¥å…·å‡½æ•°

```typescript
import { render, screen } from '@/test/utils';

// renderå‡½æ•°å·²åŒ…å«QueryClientå’ŒAnt Designé…ç½®
render(<MyComponent />);
```

### Mock APIè°ƒç”¨

```typescript
import { vi } from 'vitest';
import { chatApi } from '@/services/chat';

vi.mock('@/services/chat', () => ({
  chatApi: {
    send: vi.fn(),
    streamChat: vi.fn(),
  },
}));
```

### Mock Store

```typescript
import { useChatStore } from '@/store/slices/chatSlice';

vi.mock('@/store/slices/chatSlice', () => ({
  useChatStore: vi.fn(() => ({
    messages: [],
    addMessage: vi.fn(),
  })),
}));
```

## âœ… æµ‹è¯•æ¸…å•

### ç»„ä»¶æµ‹è¯•æ¸…å•

- [ ] ç»„ä»¶æ­£å¸¸æ¸²æŸ“
- [ ] Propsä¼ é€’æ­£ç¡®
- [ ] ç”¨æˆ·äº¤äº’ï¼ˆç‚¹å‡»ã€è¾“å…¥ç­‰ï¼‰
- [ ] æ¡ä»¶æ¸²æŸ“
- [ ] é”™è¯¯çŠ¶æ€
- [ ] åŠ è½½çŠ¶æ€

### Hookæµ‹è¯•æ¸…å•

- [ ] Hookåˆå§‹åŒ–
- [ ] è¿”å›å€¼æ­£ç¡®
- [ ] çŠ¶æ€æ›´æ–°
- [ ] å‰¯ä½œç”¨æ‰§è¡Œ
- [ ] é”™è¯¯å¤„ç†
- [ ] æ¸…ç†å‡½æ•°

### æœåŠ¡æµ‹è¯•æ¸…å•

- [ ] APIè°ƒç”¨
- [ ] è¯·æ±‚å‚æ•°
- [ ] å“åº”å¤„ç†
- [ ] é”™è¯¯å¤„ç†
- [ ] Tokenåˆ·æ–°

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1: æµ‹è¯•æ‰¾ä¸åˆ°æ¨¡å—

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ç¡®ä¿è·¯å¾„åˆ«åæ­£ç¡®
import { render } from '@/test/utils';
```

### é—®é¢˜2: Mockä¸ç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ç¡®ä¿åœ¨describeå¤–éƒ¨mock
vi.mock('@/services/chat');
```

### é—®é¢˜3: å¼‚æ­¥æµ‹è¯•å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨waitForç­‰å¾…å¼‚æ­¥æ“ä½œ
await waitFor(() => {
  expect(screen.getByText('Hello')).toBeInTheDocument();
});
```

## ğŸ“ˆ æµ‹è¯•è¿›åº¦

### å·²å®Œæˆ

- âœ… æµ‹è¯•åŸºç¡€è®¾æ–½é…ç½®
- âœ… æµ‹è¯•å·¥å…·å‡½æ•°
- âœ… éƒ¨åˆ†ç»„ä»¶æµ‹è¯•ï¼ˆMessageBubble, LoginFormç­‰ï¼‰
- âœ… éƒ¨åˆ†Hookæµ‹è¯•ï¼ˆuseAuth, useSessionsç­‰ï¼‰

### è¿›è¡Œä¸­

- â³ æ ¸å¿ƒç»„ä»¶æµ‹è¯•ï¼ˆChatContainer, EnhancedChatContainerï¼‰
- â³ æµå¼èŠå¤©Hookæµ‹è¯•
- â³ APIæœåŠ¡æµ‹è¯•

### å¾…å®Œæˆ

- â³ é›†æˆæµ‹è¯•
- â³ E2Eæµ‹è¯•ï¼ˆPlaywrightï¼‰
- â³ è¦†ç›–ç‡æå‡åˆ°60%+

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

1. **æœ¬å‘¨**: 
   - å®Œæˆæ ¸å¿ƒç»„ä»¶æµ‹è¯•
   - å®Œæˆæ ¸å¿ƒHookæµ‹è¯•
   - è¦†ç›–ç‡æå‡åˆ°30%

2. **ä¸‹å‘¨**:
   - å®ŒæˆAPIæœåŠ¡æµ‹è¯•
   - è¦†ç›–ç‡æå‡åˆ°50%

3. **æœ¬æœˆ**:
   - è¦†ç›–ç‡æå‡åˆ°60%+
   - å¼€å§‹é›†æˆæµ‹è¯•

## ğŸ“š å‚è€ƒèµ„æº

- [Vitestæ–‡æ¡£](https://vitest.dev/)
- [React Testing Libraryæ–‡æ¡£](https://testing-library.com/react)
- [Testing Best Practices](https://kentcdodds.com/blog/common-mistakes-with-react-testing-library)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-27  
**ç»´æŠ¤è€…**: CozyChat Team

