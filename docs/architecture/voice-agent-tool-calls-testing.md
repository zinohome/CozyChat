# Voice Agent å·¥å…·è°ƒç”¨æµ‹è¯•æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†æµ‹è¯•è¯­éŸ³é€šè¯ä¸­å·¥å…·è°ƒç”¨åŠŸèƒ½çš„æŒ‡å—ã€‚

## é˜¶æ®µ1ï¼šå·¥å…·è°ƒç”¨åŸºç¡€åŠŸèƒ½æµ‹è¯•

### å·²å®ç°çš„åŠŸèƒ½

1. **ToolManager** (`frontend/src/features/voice/services/ToolManager.ts`)
   - ä»åç«¯è·å–å·¥å…·åˆ—è¡¨
   - è½¬æ¢å·¥å…·æ ¼å¼ä¸º RealtimeAgent éœ€è¦çš„æ ¼å¼
   - æ‰§è¡Œå·¥å…·è°ƒç”¨
   - å·¥å…·ç¼“å­˜æœºåˆ¶

2. **EventHandler** (`frontend/src/features/voice/services/EventHandler.ts`)
   - ç›‘å¬å·¥å…·è°ƒç”¨äº‹ä»¶ (`conversation.item.created`)
   - è§£æå·¥å…·åç§°å’Œå‚æ•°
   - æ‰§è¡Œå·¥å…·å¹¶è¿”å›ç»“æœç»™ RealtimeSession

3. **useVoiceAgent é›†æˆ**
   - åœ¨ `connect()` æ—¶åŠ è½½å·¥å…·åˆ—è¡¨
   - ä¼ é€’å·¥å…·é…ç½®ç»™ RealtimeAgent
   - è®¾ç½®äº‹ä»¶å¤„ç†å™¨ç›‘å¬å·¥å…·è°ƒç”¨
   - åœ¨ `disconnect()` æ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨

### æµ‹è¯•æ­¥éª¤

#### 1. æµ‹è¯• Calculator å·¥å…·

**è¯­éŸ³è¾“å…¥ç¤ºä¾‹ï¼š**
- "å¸®æˆ‘ç®—ä¸€ä¸‹ 123 åŠ  456"
- "1234 ä¹˜ä»¥ 5678 ç­‰äºå¤šå°‘ï¼Ÿ"
- "å¸®æˆ‘è®¡ç®— 100 é™¤ä»¥ 4"

**é¢„æœŸè¡Œä¸ºï¼š**
1. ç”¨æˆ·è¯´å‡ºè®¡ç®—è¯·æ±‚
2. AI è¯†åˆ«å‡ºéœ€è¦ä½¿ç”¨ calculator å·¥å…·
3. è§¦å‘ `conversation.item.created` äº‹ä»¶ï¼ˆtype: 'function_call' æˆ– 'tool_call'ï¼‰
4. `EventHandler` è§£æå·¥å…·åç§°å’Œå‚æ•°
5. è°ƒç”¨åç«¯ `/v1/tools/execute` API
6. å°†ç»“æœè¿”å›ç»™ RealtimeSession
7. AI ç”¨è‡ªç„¶è¯­è¨€å›å¤è®¡ç®—ç»“æœ

**æ—¥å¿—è¾“å‡ºå…³é”®ç‚¹ï¼š**
```
[ToolManager] ä»åç«¯è·å–å·¥å…·åˆ—è¡¨: ...
ğŸ› ï¸ å·¥å…·åˆ—è¡¨å·²åŠ è½½: 3 ä¸ªå·¥å…·
ğŸ› ï¸ å·¥å…·è°ƒç”¨äº‹ä»¶ç›‘å¬å·²è®¾ç½®
[EventHandler] conversation.item.created: { ... }
[EventHandler] å¤„ç†å·¥å…·è°ƒç”¨: calculator { expression: "123+456" }
[ToolManager] æ‰§è¡Œå·¥å…·: calculator { expression: "123+456" }
[ToolManager] å·¥å…·æ‰§è¡ŒæˆåŠŸ: calculator 579
[EventHandler] å·¥å…·ç»“æœå·²æäº¤: calculator
```

#### 2. æµ‹è¯• Time å·¥å…·

**è¯­éŸ³è¾“å…¥ç¤ºä¾‹ï¼š**
- "ç°åœ¨å‡ ç‚¹äº†ï¼Ÿ"
- "å‘Šè¯‰æˆ‘å½“å‰æ—¶é—´"
- "å‡ ç‚¹äº†ï¼Ÿ"

**é¢„æœŸè¡Œä¸ºï¼š**
1. ç”¨æˆ·è¯¢é—®æ—¶é—´
2. AI è¯†åˆ«å‡ºéœ€è¦ä½¿ç”¨ time å·¥å…·
3. è§¦å‘å·¥å…·è°ƒç”¨äº‹ä»¶
4. è°ƒç”¨åç«¯è·å–å½“å‰æ—¶é—´
5. AI ç”¨è‡ªç„¶è¯­è¨€å›å¤æ—¶é—´

**æ—¥å¿—è¾“å‡ºå…³é”®ç‚¹ï¼š**
```
[EventHandler] å¤„ç†å·¥å…·è°ƒç”¨: time {}
[ToolManager] æ‰§è¡Œå·¥å…·: time {}
[ToolManager] å·¥å…·æ‰§è¡ŒæˆåŠŸ: time { time: "14:30:25" }
[EventHandler] å·¥å…·ç»“æœå·²æäº¤: time
```

### è°ƒè¯•æŠ€å·§

#### 1. æ£€æŸ¥å·¥å…·åˆ—è¡¨æ˜¯å¦åŠ è½½

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—ï¼š
```
ğŸ› ï¸ å·¥å…·åˆ—è¡¨å·²åŠ è½½: 3 ä¸ªå·¥å…·
```

å¦‚æœçœ‹ä¸åˆ°ï¼Œæ£€æŸ¥ï¼š
- åç«¯ `/v1/tools` API æ˜¯å¦æ­£å¸¸
- `ToolManager.getTools()` æ˜¯å¦æŠ›å‡ºå¼‚å¸¸

#### 2. æ£€æŸ¥äº‹ä»¶ç›‘å¬æ˜¯å¦è®¾ç½®

æ§åˆ¶å°åº”è¯¥æ˜¾ç¤ºï¼š
```
ğŸ› ï¸ å·¥å…·è°ƒç”¨äº‹ä»¶ç›‘å¬å·²è®¾ç½®
```

å¦‚æœçœ‹ä¸åˆ°ï¼Œæ£€æŸ¥ï¼š
- `tools.length > 0` æ˜¯å¦ä¸ºçœŸ
- `EventHandler` æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–

#### 3. æ£€æŸ¥å·¥å…·è°ƒç”¨äº‹ä»¶æ˜¯å¦è§¦å‘

åœ¨ `EventHandler.ts` ä¸­ï¼Œ`handleItemCreated` æ–¹æ³•ä¼šæ‰“å°æ‰€æœ‰ `conversation.item.created` äº‹ä»¶ã€‚æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨ç›¸å…³çš„äº‹ä»¶ã€‚

å¯èƒ½çš„äº‹ä»¶ç±»å‹ï¼š
- `item.type === 'function_call'`
- `item.type === 'tool_call'`
- `item.call?.type === 'function'`

#### 4. æ£€æŸ¥å·¥å…·å‚æ•°è§£æ

å¦‚æœå·¥å…·æ‰§è¡Œå¤±è´¥ï¼Œæ£€æŸ¥å‚æ•°è§£æé€»è¾‘ï¼š
```javascript
const parameters = item.arguments || item.function?.arguments || ...
```

å‚æ•°å¯èƒ½æ˜¯å­—ç¬¦ä¸²ï¼ˆéœ€è¦ `JSON.parse`ï¼‰æˆ–å¯¹è±¡ã€‚

#### 5. æ£€æŸ¥ç»“æœæäº¤æ–¹å¼

`submitToolResult` æ–¹æ³•å°è¯•å¤šç§æ–¹å¼æäº¤ç»“æœï¼š
1. `session.submitToolResult(callId, result)`
2. `session.send({ type: 'conversation.item.create', ... })`
3. `session.addMessage({ role: 'tool', ... })`

æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼Œçœ‹å“ªç§æ–¹å¼æˆåŠŸäº†ã€‚

### å¸¸è§é—®é¢˜

#### é—®é¢˜1ï¼šå·¥å…·åˆ—è¡¨ä¸ºç©º

**ç—‡çŠ¶ï¼š**
```
ğŸ› ï¸ å·¥å…·åˆ—è¡¨å·²åŠ è½½: 0 ä¸ªå·¥å…·
```

**å¯èƒ½åŸå› ï¼š**
- åç«¯ `/v1/tools` API æœªè¿”å›å·¥å…·
- å·¥å…·æœªæ³¨å†Œåˆ° `ToolRegistry`
- å·¥å…·è¢«ç¦ç”¨ï¼ˆ`enabled: false`ï¼‰

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥åç«¯ `backend/app/engines/tools/registry.py`
2. ç¡®ä¿ `CalculatorTool` å’Œ `TimeTool` å·²æ³¨å†Œ
3. æ£€æŸ¥å·¥å…·çš„ `enabled` å±æ€§

#### é—®é¢˜2ï¼šäº‹ä»¶ç›‘å¬æœªè®¾ç½®

**ç—‡çŠ¶ï¼š**
æ²¡æœ‰çœ‹åˆ° "ğŸ› ï¸ å·¥å…·è°ƒç”¨äº‹ä»¶ç›‘å¬å·²è®¾ç½®" æ—¥å¿—

**å¯èƒ½åŸå› ï¼š**
- `tools.length === 0`
- `EventHandler` åˆå§‹åŒ–å¤±è´¥

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥å·¥å…·åˆ—è¡¨åŠ è½½æ˜¯å¦æˆåŠŸ
2. æ£€æŸ¥ `eventHandlerRef.current` æ˜¯å¦ä¸º null

#### é—®é¢˜3ï¼šå·¥å…·è°ƒç”¨äº‹ä»¶ä¸è§¦å‘

**ç—‡çŠ¶ï¼š**
- æ²¡æœ‰çœ‹åˆ° `[EventHandler] conversation.item.created` æ—¥å¿—
- AI æ²¡æœ‰è°ƒç”¨å·¥å…·ï¼Œç›´æ¥å›å¤

**å¯èƒ½åŸå› ï¼š**
- AI æ²¡æœ‰è¯†åˆ«å‡ºéœ€è¦è°ƒç”¨å·¥å…·
- å·¥å…·æè¿°ä¸å¤Ÿæ¸…æ™°
- `instructions` ä¸­æ²¡æœ‰æç¤ºä½¿ç”¨å·¥å…·

**è§£å†³æ–¹æ³•ï¼š**
1. ä¼˜åŒ–å·¥å…·çš„ `description`ï¼Œä½¿å…¶æ›´æ˜ç¡®
2. åœ¨ `instructions` ä¸­æ·»åŠ æç¤ºï¼š
   ```
   You have access to tools like calculator and time. 
   Use them when appropriate.
   ```

#### é—®é¢˜4ï¼šå·¥å…·æ‰§è¡Œå¤±è´¥

**ç—‡çŠ¶ï¼š**
```
[ToolManager] å·¥å…·æ‰§è¡Œå¤±è´¥: calculator Error: ...
```

**å¯èƒ½åŸå› ï¼š**
- åç«¯ `/v1/tools/execute` API å¤±è´¥
- å·¥å…·å‚æ•°æ ¼å¼ä¸æ­£ç¡®
- å·¥å…·å®ç°æœ‰ bug

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥åç«¯æ—¥å¿—
2. æ£€æŸ¥å‚æ•°æ˜¯å¦æ­£ç¡®ä¼ é€’
3. æ‰‹åŠ¨è°ƒç”¨ `/v1/tools/execute` API æµ‹è¯•

#### é—®é¢˜5ï¼šç»“æœæ— æ³•æäº¤ç»™ Session

**ç—‡çŠ¶ï¼š**
```
[EventHandler] æ— æ³•æ‰¾åˆ°æäº¤å·¥å…·ç»“æœçš„æ–¹æ³•
```

**å¯èƒ½åŸå› ï¼š**
- `RealtimeSession` çš„ API å‘ç”Ÿå˜åŒ–
- SDK ç‰ˆæœ¬ä¸åŒ¹é…

**è§£å†³æ–¹æ³•ï¼š**
1. æŸ¥çœ‹ OpenAI Agents SDK æ–‡æ¡£
2. æ£€æŸ¥ `RealtimeSession` çš„å¯ç”¨æ–¹æ³•
3. æ·»åŠ æ–°çš„æäº¤æ–¹å¼åˆ° `submitToolResult` æ–¹æ³•

### æˆåŠŸæ ‡å‡†

é˜¶æ®µ1 å·¥å…·è°ƒç”¨åŠŸèƒ½æµ‹è¯•é€šè¿‡çš„æ ‡å‡†ï¼š

- [ ] å·¥å…·åˆ—è¡¨æˆåŠŸåŠ è½½ï¼ˆè‡³å°‘åŒ…å« calculator å’Œ timeï¼‰
- [ ] å·¥å…·è°ƒç”¨äº‹ä»¶ç›‘å¬å·²è®¾ç½®
- [ ] Calculator å·¥å…·è°ƒç”¨æˆåŠŸï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰
- [ ] Time å·¥å…·è°ƒç”¨æˆåŠŸï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰
- [ ] AI èƒ½å¤Ÿç”¨è‡ªç„¶è¯­è¨€å›å¤å·¥å…·æ‰§è¡Œç»“æœ
- [ ] æ§åˆ¶å°æ²¡æœ‰é”™è¯¯æ—¥å¿—

### ä¸‹ä¸€æ­¥

å®Œæˆé˜¶æ®µ1æµ‹è¯•åï¼Œå°†è¿›å…¥é˜¶æ®µ2ï¼šæ¶æ„é‡æ„ã€‚

