# CozyChat å‰ç«¯å¼€å‘è§„èŒƒ

> **æ–‡æ¡£ä½ç½®**: `docs/17-å‰ç«¯å¼€å‘è§„èŒƒ.md`  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-07  
> **æœ€åæ›´æ–°**: 2025-11-07

## ğŸ“‹ ç›®å½•

1. [æŠ€æœ¯æ ˆè§„èŒƒ](#æŠ€æœ¯æ ˆè§„èŒƒ)
2. [é¡¹ç›®ç»“æ„è§„èŒƒ](#é¡¹ç›®ç»“æ„è§„èŒƒ)
3. [ä»£ç é£æ ¼è§„èŒƒ](#ä»£ç é£æ ¼è§„èŒƒ)
4. [ç»„ä»¶å¼€å‘è§„èŒƒ](#ç»„ä»¶å¼€å‘è§„èŒƒ)
5. [çŠ¶æ€ç®¡ç†è§„èŒƒ](#çŠ¶æ€ç®¡ç†è§„èŒƒ)
6. [APIè°ƒç”¨è§„èŒƒ](#apiè°ƒç”¨è§„èŒƒ)
7. [æ ·å¼è§„èŒƒ](#æ ·å¼è§„èŒƒ)
8. [æ€§èƒ½ä¼˜åŒ–è§„èŒƒ](#æ€§èƒ½ä¼˜åŒ–è§„èŒƒ)
9. [æµ‹è¯•è§„èŒƒ](#æµ‹è¯•è§„èŒƒ)
10. [Gitæäº¤è§„èŒƒ](#gitæäº¤è§„èŒƒ)

---

## 1. æŠ€æœ¯æ ˆè§„èŒƒ

### 1.1 æ ¸å¿ƒæ¡†æ¶

```yaml
UIæ¡†æ¶: React 18+
ç±»å‹ç³»ç»Ÿ: TypeScript 5+
æ„å»ºå·¥å…·: Vite 5+
åŒ…ç®¡ç†å™¨: pnpm (é¦–é€‰) / yarn / npm
```

### 1.2 UIç»„ä»¶åº“

```yaml
AIèŠå¤©ç»„ä»¶:
  - @chatui/core: é¦–é€‰ï¼ˆä¸“ä¸ºèŠå¤©è®¾è®¡ï¼ŒåŠŸèƒ½å®Œæ•´ï¼Œä¼ä¸šçº§æˆç†Ÿåº¦ï¼‰
  - @chatui/react: Reactç»„ä»¶ï¼ˆå¯é€‰ï¼‰

é€šç”¨UIç»„ä»¶:
  - antd: æˆç†Ÿçš„Reactç»„ä»¶åº“ï¼ˆå¸ƒå±€ã€è¡¨å•ã€åé¦ˆã€Drawerç­‰ï¼‰
  - @ant-design/icons: å›¾æ ‡åº“

æ ·å¼æ–¹æ¡ˆ:
  - @chatui/core: ç»„ä»¶æ ·å¼ï¼ˆèŠå¤©ç»„ä»¶ï¼‰
  - antd: ç»„ä»¶æ ·å¼ï¼ˆé€šç”¨ç»„ä»¶ï¼‰
  - tailwindcss: åŸå­åŒ–CSSï¼ˆè‡ªå®šä¹‰æ ·å¼ï¼Œå¯é€‰ï¼‰
  - CSS Modules: ä½œä¸ºå¤‡é€‰
```

### 1.3 çŠ¶æ€ç®¡ç†

```yaml
å…¨å±€çŠ¶æ€:
  - zustand: è½»é‡çº§çŠ¶æ€ç®¡ç†ï¼ˆé¦–é€‰ï¼‰
  - æˆ– Jotai: åŸå­åŒ–çŠ¶æ€ç®¡ç†ï¼ˆå¤‡é€‰ï¼‰

æœåŠ¡ç«¯çŠ¶æ€:
  - @tanstack/react-query: 
    * æ•°æ®è·å–
    * ç¼“å­˜ç®¡ç†
    * ä¹è§‚æ›´æ–°

è¡¨å•çŠ¶æ€:
  - React Hook Form: è¡¨å•ç®¡ç†
  - Zod: æ•°æ®éªŒè¯
```

### 1.4 è·¯ç”±å’Œå¯¼èˆª

```yaml
è·¯ç”±: React Router v6+
- åµŒå¥—è·¯ç”±
- è·¯ç”±å®ˆå«
- æ‡’åŠ è½½

å¯¼èˆª:
- é¢åŒ…å±‘å¯¼èˆª
- ä¾§è¾¹æ å¯¼èˆª
- ç§»åŠ¨ç«¯æŠ½å±‰å¯¼èˆª
```

### 1.5 å®æ—¶é€šä¿¡

```yaml
WebSocket:
  - åŸç”ŸWebSocket API
  - è‡ªåŠ¨é‡è¿æœºåˆ¶
  - å¿ƒè·³æ£€æµ‹

SSE (Server-Sent Events):
  - EventSource API
  - æµå¼æ•°æ®å¤„ç†
  - è‡ªåŠ¨é‡è¿

HTTP:
  - Axios: HTTPå®¢æˆ·ç«¯
  - è¯·æ±‚æ‹¦æˆªå™¨
  - å“åº”æ‹¦æˆªå™¨
```

### 1.6 å·¥å…·åº“

```yaml
æ—¥æœŸå¤„ç†: date-fns
éŸ³é¢‘å¤„ç†: Web Audio API + Recorder.js
æ–‡ä»¶å¤„ç†: file-saver
Markdownæ¸²æŸ“: react-markdown + remark-gfm
ä»£ç é«˜äº®: prismjs / highlight.js
å¯Œæ–‡æœ¬ç¼–è¾‘: TipTap (å¯é€‰)
```

---

## 2. é¡¹ç›®ç»“æ„è§„èŒƒ

### 2.1 ç›®å½•ç»“æ„

```
frontend/
â”œâ”€â”€ public/                 # é™æ€èµ„æº
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â””â”€â”€ assets/
â”‚       â””â”€â”€ images/
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/         # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ui/            # UIåŸºç¡€ç»„ä»¶ï¼ˆButton, Inputç­‰ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ Button/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Button.module.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Button.test.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ layout/        # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Header/
â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar/
â”‚   â”‚   â”‚   â””â”€â”€ Footer/
â”‚   â”‚   â””â”€â”€ chat/          # èŠå¤©ç›¸å…³ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ ChatMessage/
â”‚   â”‚       â”œâ”€â”€ ChatInput/
â”‚   â”‚       â””â”€â”€ ChatContainer/
â”‚   â”‚
â”‚   â”œâ”€â”€ features/          # åŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth/          # è®¤è¯æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ chat/          # èŠå¤©æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ settings/       # è®¾ç½®æ¨¡å—
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/             # å…¨å±€Hooks
â”‚   â”‚   â”œâ”€â”€ useAuth.ts
â”‚   â”‚   â”œâ”€â”€ useChat.ts
â”‚   â”‚   â””â”€â”€ useWebSocket.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ services/          # APIæœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ api.ts         # APIå®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ chat.ts        # èŠå¤©API
â”‚   â”‚   â”œâ”€â”€ user.ts        # ç”¨æˆ·API
â”‚   â”‚   â””â”€â”€ voice.ts       # è¯­éŸ³API
â”‚   â”‚
â”‚   â”œâ”€â”€ store/             # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ slices/        # Zustand slices
â”‚   â”‚   â”‚   â”œâ”€â”€ authSlice.ts
â”‚   â”‚   â”‚   â””â”€â”€ chatSlice.ts
â”‚   â”‚   â””â”€â”€ store.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ types/             # TypeScriptç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ user.ts
â”‚   â”‚   â”œâ”€â”€ chat.ts
â”‚   â”‚   â””â”€â”€ api.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ format.ts
â”‚   â”‚   â”œâ”€â”€ storage.ts
â”‚   â”‚   â””â”€â”€ validation.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ styles/            # å…¨å±€æ ·å¼
â”‚   â”‚   â”œâ”€â”€ globals.css
â”‚   â”‚   â”œâ”€â”€ variables.css
â”‚   â”‚   â””â”€â”€ reset.css
â”‚   â”‚
â”‚   â”œâ”€â”€ App.tsx            # åº”ç”¨å…¥å£
â”‚   â””â”€â”€ main.tsx            # åº”ç”¨å¯åŠ¨
â”‚
â”œâ”€â”€ .env.example           # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .eslintrc.json         # ESLinté…ç½®
â”œâ”€â”€ .prettierrc            # Prettieré…ç½®
â”œâ”€â”€ tsconfig.json          # TypeScripté…ç½®
â”œâ”€â”€ vite.config.ts         # Viteé…ç½®
â””â”€â”€ package.json           # ä¾èµ–ç®¡ç†
```

### 2.2 æ–‡ä»¶å‘½åè§„èŒƒ

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| **ç»„ä»¶æ–‡ä»¶** | å¤§é©¼å³° | `ChatMessage.tsx` |
| **ç»„ä»¶ç›®å½•** | å¤§é©¼å³° | `ChatMessage/` |
| **Hooksæ–‡ä»¶** | useå¼€å¤´+å°é©¼å³° | `useChat.ts` |
| **å·¥å…·å‡½æ•°** | å°é©¼å³° | `formatDate.ts` |
| **ç±»å‹å®šä¹‰** | å°é©¼å³° | `chat.ts` |
| **æ ·å¼æ–‡ä»¶** | ç»„ä»¶å.module.css | `ChatMessage.module.css` |
| **æµ‹è¯•æ–‡ä»¶** | ç»„ä»¶å.test.tsx | `ChatMessage.test.tsx` |

---

## 3. ä»£ç é£æ ¼è§„èŒƒ

### 3.1 TypeScripté…ç½®

```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

### 3.2 ESLinté…ç½®

```json
// .eslintrc.json
{
  "extends": [
    "react-app",
    "react-app/jest",
    "plugin:@typescript-eslint/recommended",
    "prettier"
  ],
  "plugins": ["@typescript-eslint", "react-hooks"],
  "rules": {
    "react-hooks/rules-of-hooks": "error",
    "react-hooks/exhaustive-deps": "warn",
    "@typescript-eslint/explicit-module-boundary-types": "off",
    "@typescript-eslint/no-explicit-any": "warn",
    "no-console": ["warn", { "allow": ["warn", "error"] }],
    "prefer-const": "error",
    "no-unused-vars": "off",
    "@typescript-eslint/no-unused-vars": ["warn", { "argsIgnorePattern": "^_" }]
  }
}
```

### 3.3 Prettieré…ç½®

```json
// .prettierrc
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2,
  "arrowParens": "always",
  "endOfLine": "lf"
}
```

### 3.4 å¯¼å…¥é¡ºåº

```typescript
// 1. Reactç›¸å…³
import React, { useState, useEffect, useCallback } from 'react';

// 2. ç¬¬ä¸‰æ–¹åº“
import { Chat } from '@chatui/core';
import { Button, Drawer } from 'antd';
import { useQuery } from '@tanstack/react-query';

// 3. æœ¬åœ°ç»„ä»¶
import { ChatMessage } from '@/components/chat/ChatMessage';
import { Header } from '@/components/layout/Header';

// 4. Hooks
import { useChat } from '@/hooks/useChat';
import { useAuth } from '@/hooks/useAuth';

// 5. æœåŠ¡
import { chatApi } from '@/services/chat';

// 6. ç±»å‹
import type { Message, ChatState } from '@/types/chat';

// 7. å·¥å…·å‡½æ•°
import { formatDate } from '@/utils/format';

// 8. æ ·å¼
import styles from './ChatPage.module.css';
```

---

## 4. ç»„ä»¶å¼€å‘è§„èŒƒ

### 4.1 å‡½æ•°ç»„ä»¶è§„èŒƒ

```typescript
// src/components/chat/ChatMessage/ChatMessage.tsx
import React from 'react';
import { format } from 'date-fns';
import { UserOutlined, RobotOutlined } from '@ant-design/icons';
import styles from './ChatMessage.module.css';

/**
 * èŠå¤©æ¶ˆæ¯ç»„ä»¶å±æ€§
 */
interface ChatMessageProps {
  /** æ¶ˆæ¯è§’è‰² */
  role: 'user' | 'assistant';
  /** æ¶ˆæ¯å†…å®¹ */
  content: string;
  /** æ—¶é—´æˆ³ */
  timestamp: Date;
  /** æ˜¯å¦æ­£åœ¨åŠ è½½ */
  loading?: boolean;
  /** ç‚¹å‡»å›è°ƒ */
  onClick?: () => void;
}

/**
 * èŠå¤©æ¶ˆæ¯ç»„ä»¶
 * 
 * æ˜¾ç¤ºå•æ¡èŠå¤©æ¶ˆæ¯ï¼Œæ”¯æŒç”¨æˆ·å’ŒAIä¸¤ç§è§’è‰²ã€‚
 * 
 * @example
 * ```tsx
 * <ChatMessage
 *   role="user"
 *   content="Hello, AI!"
 *   timestamp={new Date()}
 * />
 * ```
 */
const ChatMessage: React.FC<ChatMessageProps> = ({
  role,
  content,
  timestamp,
  loading = false,
  onClick,
}) => {
  const formattedTime = format(timestamp, 'HH:mm');
  
  return (
    <div
      className={`${styles.message} ${styles[role]}`}
      data-testid={`${role}-message`}
      onClick={onClick}
    >
      <div className={styles.avatar}>
        {role === 'user' ? <UserOutlined /> : <RobotOutlined />}
      </div>
      <div className={styles.content}>
        <div className={styles.text}>
          {loading ? <LoadingDots /> : content}
        </div>
        <div className={styles.timestamp}>{formattedTime}</div>
      </div>
    </div>
  );
};

export default React.memo(ChatMessage);
export type { ChatMessageProps };
```

### 4.2 ç»„ä»¶æœ€ä½³å®è·µ

1. **ä½¿ç”¨å‡½æ•°ç»„ä»¶å’ŒHooks**ï¼Œé¿å…ç±»ç»„ä»¶
2. **Propsä½¿ç”¨TypeScriptæ¥å£å®šä¹‰**ï¼Œå¿…é¡»åŒ…å«JSDocæ³¨é‡Š
3. **å¯¼å‡ºç»„ä»¶å’Œç±»å‹**:
```typescript
export type { ChatMessageProps };
export default ChatMessage;
```

4. **ä½¿ç”¨React.memoä¼˜åŒ–æ€§èƒ½**:
```typescript
export default React.memo(ChatMessage);
```

5. **æ¡ä»¶æ¸²æŸ“**:
```typescript
// âœ… å¥½çš„å†™æ³•
{isLoading && <Spinner />}
{error ? <ErrorMessage error={error} /> : <Content />}

// âŒ é¿å…
{isLoading ? <Spinner /> : null}
```

6. **ä½¿ç”¨data-testidç”¨äºæµ‹è¯•**:
```typescript
<div data-testid="chat-message">...</div>
```

### 4.3 ChatUIç»„ä»¶ä½¿ç”¨è§„èŒƒ

```typescript
// src/features/chat/components/ChatContainer/ChatContainer.tsx
import React, { useState, useCallback } from 'react';
import { Chat, Navbar, MessageList, MessageInput } from '@chatui/core';
import '@chatui/core/dist/index.css';
import { useChat } from '@/hooks/useChat';
import type { Message } from '@/types/chat';

interface ChatContainerProps {
  /** ä¼šè¯ID */
  sessionId: string;
  /** äººæ ¼ID */
  personalityId: string;
}

/**
 * èŠå¤©å®¹å™¨ç»„ä»¶
 * 
 * ä½¿ç”¨ChatUIæ ¸å¿ƒç»„ä»¶æ„å»ºèŠå¤©ç•Œé¢ã€‚
 */
const ChatContainer: React.FC<ChatContainerProps> = ({
  sessionId,
  personalityId,
}) => {
  const { messages, sendMessage, isLoading } = useChat(sessionId, personalityId);
  
  const handleSend = useCallback(
    async (type: string, val: string) => {
      if (type === 'text' && val.trim()) {
        await sendMessage(val);
      }
    },
    [sendMessage]
  );
  
  return (
    <Chat
      navbar={{
        title: 'CozyChat',
      }}
      messages={messages}
      onSend={handleSend}
      placeholder="è¾“å…¥æ¶ˆæ¯..."
      locale="zh-CN"
    />
  );
};

export default ChatContainer;
```

### 4.4 Ant Designç»„ä»¶ä½¿ç”¨è§„èŒƒ

```typescript
// src/components/user/HealthRecordDrawer/HealthRecordDrawer.tsx
import React from 'react';
import { Drawer, Tabs, Space } from 'antd';
import { UserOutlined } from '@ant-design/icons';
import type { DrawerProps } from 'antd';

interface HealthRecordDrawerProps {
  /** æ˜¯å¦å¯è§ */
  open: boolean;
  /** å…³é—­å›è°ƒ */
  onClose: () => void;
}

/**
 * å¥åº·æ¡£æ¡ˆæŠ½å±‰ç»„ä»¶
 * 
 * ä½¿ç”¨Ant Designçš„Drawerç»„ä»¶å®ç°ä¾§è¾¹æ ã€‚
 */
const HealthRecordDrawer: React.FC<HealthRecordDrawerProps> = ({
  open,
  onClose,
}) => {
  const tabItems = [
    {
      key: 'basic',
      label: 'åŸºæœ¬ä¿¡æ¯',
      children: <BasicInfo />,
    },
    {
      key: 'health',
      label: 'å¥åº·è®°å½•',
      children: <HealthRecords />,
    },
  ];
  
  return (
    <Drawer
      title={
        <Space>
          <UserOutlined />
          å¥åº·æ¡£æ¡ˆ
        </Space>
      }
      placement="right"
      width={600}
      open={open}
      onClose={onClose}
      maskClosable={false}
    >
      <Tabs items={tabItems} />
    </Drawer>
  );
};

export default HealthRecordDrawer;
```

---

## 5. çŠ¶æ€ç®¡ç†è§„èŒƒ

### 5.1 Zustand Storeè§„èŒƒ

```typescript
// src/store/slices/chatSlice.ts
import { create } from 'zustand';
import { devtools, persist } from 'zustand/middleware';
import type { Message, ChatState } from '@/types/chat';

interface ChatStore extends ChatState {
  // Actions
  addMessage: (message: Message) => void;
  clearMessages: () => void;
  setLoading: (loading: boolean) => void;
  setError: (error: string | null) => void;
}

/**
 * èŠå¤©çŠ¶æ€ç®¡ç†Store
 * 
 * ä½¿ç”¨Zustandç®¡ç†èŠå¤©ç›¸å…³çš„å…¨å±€çŠ¶æ€ã€‚
 */
export const useChatStore = create<ChatStore>()(
  devtools(
    persist(
      (set) => ({
        // State
        messages: [],
        loading: false,
        error: null,
        
        // Actions
        addMessage: (message) =>
          set((state) => ({
            messages: [...state.messages, message],
          })),
        
        clearMessages: () =>
          set({
            messages: [],
            error: null,
          }),
        
        setLoading: (loading) =>
          set({ loading }),
        
        setError: (error) =>
          set({ error }),
      }),
      {
        name: 'chat-storage',
        partialize: (state) => ({
          messages: state.messages,
        }),
      }
    ),
    { name: 'ChatStore' }
  )
);
```

### 5.2 React Queryè§„èŒƒ

```typescript
// src/hooks/useChat.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { chatApi } from '@/services/chat';
import type { Message, ChatRequest } from '@/types/chat';

/**
 * èŠå¤©Hook
 * 
 * ä½¿ç”¨React Queryç®¡ç†èŠå¤©ç›¸å…³çš„æœåŠ¡ç«¯çŠ¶æ€ã€‚
 */
export const useChat = (sessionId: string, personalityId: string) => {
  const queryClient = useQueryClient();
  
  // è·å–å†å²æ¶ˆæ¯
  const { data: messages = [], isLoading } = useQuery({
    queryKey: ['chat', 'messages', sessionId],
    queryFn: () => chatApi.getHistory(sessionId),
    enabled: !!sessionId,
  });
  
  // å‘é€æ¶ˆæ¯
  const sendMutation = useMutation({
    mutationFn: (request: ChatRequest) => chatApi.send(request),
    onSuccess: (response) => {
      // æ›´æ–°ç¼“å­˜
      queryClient.setQueryData(
        ['chat', 'messages', sessionId],
        (old: Message[] = []) => [...old, response.message]
      );
    },
  });
  
  const sendMessage = async (content: string) => {
    await sendMutation.mutateAsync({
      messages: [
        ...messages.map((m) => ({
          role: m.role,
          content: m.content,
        })),
        { role: 'user', content },
      ],
      personality_id: personalityId,
      stream: false,
    });
  };
  
  return {
    messages,
    isLoading,
    sendMessage,
    isSending: sendMutation.isPending,
  };
};
```

---

## 6. APIè°ƒç”¨è§„èŒƒ

### 6.1 APIå®¢æˆ·ç«¯è§„èŒƒ

```typescript
// src/services/api.ts
import axios, { AxiosInstance, AxiosRequestConfig, AxiosResponse } from 'axios';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000';

/**
 * APIå®¢æˆ·ç«¯ç±»
 * 
 * å°è£…Axiosï¼Œæä¾›ç»Ÿä¸€çš„APIè°ƒç”¨æ¥å£ã€‚
 */
class ApiClient {
  private client: AxiosInstance;

  constructor() {
    this.client = axios.create({
      baseURL: API_BASE_URL,
      timeout: 30000,
      headers: {
        'Content-Type': 'application/json',
      },
    });

    this.setupInterceptors();
  }

  private setupInterceptors() {
    // è¯·æ±‚æ‹¦æˆªå™¨
    this.client.interceptors.request.use(
      (config) => {
        const token = localStorage.getItem('access_token');
        if (token) {
          config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
      },
      (error) => Promise.reject(error)
    );

    // å“åº”æ‹¦æˆªå™¨
    this.client.interceptors.response.use(
      (response) => response,
      (error) => {
        if (error.response?.status === 401) {
          // å¤„ç†è®¤è¯å¤±è´¥
          localStorage.removeItem('access_token');
          window.location.href = '/login';
        }
        return Promise.reject(error);
      }
    );
  }

  async get<T>(url: string, config?: AxiosRequestConfig): Promise<T> {
    const response = await this.client.get<T>(url, config);
    return response.data;
  }

  async post<T>(url: string, data?: any, config?: AxiosRequestConfig): Promise<T> {
    const response = await this.client.post<T>(url, data, config);
    return response.data;
  }

  async put<T>(url: string, data?: any, config?: AxiosRequestConfig): Promise<T> {
    const response = await this.client.put<T>(url, data, config);
    return response.data;
  }

  async delete<T>(url: string, config?: AxiosRequestConfig): Promise<T> {
    const response = await this.client.delete<T>(url, config);
    return response.data;
  }
}

export const apiClient = new ApiClient();
```

### 6.2 APIæœåŠ¡è§„èŒƒ

```typescript
// src/services/chat.ts
import { apiClient } from './api';
import type { Message, ChatRequest, ChatResponse } from '@/types/chat';

/**
 * èŠå¤©APIæœåŠ¡
 * 
 * å°è£…èŠå¤©ç›¸å…³çš„APIè°ƒç”¨ã€‚
 */
export const chatApi = {
  /**
   * å‘é€èŠå¤©æ¶ˆæ¯
   */
  async send(request: ChatRequest): Promise<ChatResponse> {
    return apiClient.post<ChatResponse>('/v1/chat/completions', request);
  },

  /**
   * è·å–å†å²æ¶ˆæ¯
   */
  async getHistory(sessionId: string): Promise<Message[]> {
    return apiClient.get<Message[]>(`/v1/chat/sessions/${sessionId}/messages`);
  },

  /**
   * æµå¼èŠå¤©ï¼ˆSSEï¼‰
   */
  async *streamChat(request: ChatRequest): AsyncGenerator<string> {
    const response = await fetch(
      `${import.meta.env.VITE_API_BASE_URL}/v1/chat/stream`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem('access_token')}`,
        },
        body: JSON.stringify(request),
      }
    );

    const reader = response.body?.getReader();
    const decoder = new TextDecoder();

    while (true) {
      const { done, value } = await reader!.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') return;
          yield data;
        }
      }
    }
  },
};
```

---

## 7. æ ·å¼è§„èŒƒ

### 7.1 CSS Modulesè§„èŒƒ

```css
/* src/components/chat/ChatMessage/ChatMessage.module.css */
.message {
  display: flex;
  gap: 12px;
  padding: 16px;
  margin-bottom: 12px;
  border-radius: 8px;
  transition: background-color 0.2s;
}

.message:hover {
  background-color: var(--hover-bg);
}

.user {
  flex-direction: row-reverse;
  background-color: var(--user-message-bg);
}

.assistant {
  background-color: var(--assistant-message-bg);
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.content {
  flex: 1;
  min-width: 0; /* é˜²æ­¢æ–‡æœ¬æº¢å‡º */
}

.text {
  word-wrap: break-word;
  white-space: pre-wrap;
}

.timestamp {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 4px;
}
```

### 7.2 CSSå˜é‡è§„èŒƒ

```css
/* src/styles/variables.css */
:root {
  /* Colors */
  --primary-color: #3b82f6;
  --secondary-color: #64748b;
  --success-color: #10b981;
  --error-color: #ef4444;
  
  /* Backgrounds */
  --bg-primary: #ffffff;
  --bg-secondary: #f8fafc;
  --hover-bg: #f1f5f9;
  
  /* Text */
  --text-primary: #0f172a;
  --text-secondary: #64748b;
  
  /* Spacing */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  
  /* Border */
  --border-radius: 8px;
  --border-color: #e2e8f0;
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --hover-bg: #334155;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --border-color: #334155;
  }
}
```

### 7.3 TailwindCSSè§„èŒƒï¼ˆå¯é€‰ï¼‰

```typescript
// tailwind.config.js
/** @type {import('tailwindcss').Config} */
export default {
  content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'],
  theme: {
    extend: {
      colors: {
        primary: '#3b82f6',
        secondary: '#64748b',
      },
    },
  },
  plugins: [],
};
```

---

## 8. æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### 8.1 ä»£ç åˆ†å‰²

```typescript
// è·¯ç”±æ‡’åŠ è½½
import { lazy, Suspense } from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';

const Chat = lazy(() => import('./features/chat/Chat'));
const Settings = lazy(() => import('./features/settings/Settings'));

function App() {
  return (
    <BrowserRouter>
      <Suspense fallback={<Loading />}>
        <Routes>
          <Route path="/chat" element={<Chat />} />
          <Route path="/settings" element={<Settings />} />
        </Routes>
      </Suspense>
    </BrowserRouter>
  );
}
```

### 8.2 useMemoå’ŒuseCallback

```typescript
import { useMemo, useCallback } from 'react';

function ChatList({ messages, onMessageClick }) {
  // ç¼“å­˜è®¡ç®—ç»“æœ
  const sortedMessages = useMemo(() => {
    return messages.sort((a, b) => a.timestamp - b.timestamp);
  }, [messages]);

  // ç¼“å­˜å›è°ƒå‡½æ•°
  const handleClick = useCallback(
    (id: string) => {
      onMessageClick(id);
    },
    [onMessageClick]
  );

  return (
    <div>
      {sortedMessages.map((msg) => (
        <ChatMessage key={msg.id} {...msg} onClick={() => handleClick(msg.id)} />
      ))}
    </div>
  );
}
```

### 8.3 è™šæ‹Ÿæ»šåŠ¨

```typescript
import { FixedSizeList } from 'react-window';

function MessageList({ messages }) {
  const Row = ({ index, style }) => (
    <div style={style}>
      <ChatMessage {...messages[index]} />
    </div>
  );

  return (
    <FixedSizeList
      height={600}
      itemCount={messages.length}
      itemSize={100}
      width="100%"
    >
      {Row}
    </FixedSizeList>
  );
}
```

---

## 9. æµ‹è¯•è§„èŒƒ

### 9.1 ç»„ä»¶æµ‹è¯•

```typescript
// src/components/chat/ChatMessage/ChatMessage.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import ChatMessage from './ChatMessage';

describe('ChatMessage', () => {
  it('renders user message correctly', () => {
    render(
      <ChatMessage
        role="user"
        content="Hello"
        timestamp={new Date()}
      />
    );
    
    expect(screen.getByText('Hello')).toBeInTheDocument();
    expect(screen.getByTestId('user-message')).toBeInTheDocument();
  });
  
  it('calls onClick when clicked', () => {
    const handleClick = vi.fn();
    render(
      <ChatMessage
        role="user"
        content="Hello"
        onClick={handleClick}
        timestamp={new Date()}
      />
    );
    
    fireEvent.click(screen.getByTestId('user-message'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });
});
```

### 9.2 Hookæµ‹è¯•

```typescript
// src/hooks/useChat.test.ts
import { renderHook, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useChat } from './useChat';

describe('useChat', () => {
  it('fetches messages successfully', async () => {
    const queryClient = new QueryClient();
    const wrapper = ({ children }) => (
      <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
    );
    
    const { result } = renderHook(() => useChat('session-1', 'personality-1'), {
      wrapper,
    });
    
    await waitFor(() => expect(result.current.isLoading).toBe(false));
    expect(result.current.messages).toBeDefined();
  });
});
```

---

## 10. Gitæäº¤è§„èŒƒ

### 10.1 Conventional Commits

ä½¿ç”¨ **Conventional Commits** æ ¼å¼ï¼š

```
<type>(<scope>): <subject>

<body>

<footer>
```

**ç±»å‹**:
- `feat`: æ–°åŠŸèƒ½
- `fix`: Bugä¿®å¤
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: ä»£ç æ ¼å¼
- `refactor`: é‡æ„
- `test`: æµ‹è¯•
- `chore`: æ„å»º/å·¥å…·

**ç¤ºä¾‹**:

```bash
feat(chat): add streaming response support

- Implement SSE for chat streaming
- Add loading indicator
- Update API client

Closes #123
```

---

## 11. æ€»ç»“

æœ¬æ–‡æ¡£å®šä¹‰äº†CozyChaté¡¹ç›®çš„å‰ç«¯å¼€å‘è§„èŒƒï¼ŒåŒ…æ‹¬ï¼š

âœ… **æŠ€æœ¯æ ˆè§„èŒƒ**: ChatUI + Ant Design + Zustand + React Query  
âœ… **é¡¹ç›®ç»“æ„è§„èŒƒ**: æ¸…æ™°çš„ç›®å½•ç»„ç»‡å’Œæ–‡ä»¶å‘½å  
âœ… **ä»£ç é£æ ¼è§„èŒƒ**: TypeScript + ESLint + Prettier  
âœ… **ç»„ä»¶å¼€å‘è§„èŒƒ**: å‡½æ•°ç»„ä»¶ + Hooks + ç±»å‹å®šä¹‰  
âœ… **çŠ¶æ€ç®¡ç†è§„èŒƒ**: Zustand + React Query  
âœ… **APIè°ƒç”¨è§„èŒƒ**: Axioså°è£… + ç»Ÿä¸€é”™è¯¯å¤„ç†  
âœ… **æ ·å¼è§„èŒƒ**: CSS Modules + CSSå˜é‡  
âœ… **æ€§èƒ½ä¼˜åŒ–è§„èŒƒ**: ä»£ç åˆ†å‰² + è™šæ‹Ÿæ»šåŠ¨  
âœ… **æµ‹è¯•è§„èŒƒ**: ç»„ä»¶æµ‹è¯• + Hookæµ‹è¯•  

**å¼ºåˆ¶æ‰§è¡Œ**:
- Pre-commit hooksè‡ªåŠ¨æ£€æŸ¥
- CI/CDæµç¨‹éªŒè¯
- Code Reviewå¿…é¡»é€šè¿‡

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-07  
**ç»´æŠ¤è€…**: CozyChat Team

