# CozyChat 数据库设计

## 1. 数据库选型

### 1.1 PostgreSQL（主数据库）

**选择理由**:
- ✅ ACID事务保证
- ✅ JSONB支持，灵活存储配置
- ✅ 全文搜索功能
- ✅ 连接池管理成熟
- ✅ 丰富的索引类型
- ✅ pg_vector扩展（向量搜索）

### 1.2 Redis（缓存层）

**用途**:
- 会话缓存
- API限流
- 记忆检索缓存
- WebSocket连接管理

### 1.3 ChromaDB/Qdrant（向量数据库）

**用途**:
- 用户记忆向量存储
- AI记忆向量存储
- 语义搜索

## 2. 数据库连接配置

### 2.1 连接池配置（SQLAlchemy）

```yaml
# config/database.yaml
database:
  url: "postgresql://user:password@localhost:5432/cozychat"
  pool_size: 20
  max_overflow: 10
  pool_timeout: 30
  pool_recycle: 3600
  echo: false
  
  # 读写分离（可选）
  read_replicas:
    - "postgresql://user:password@replica1:5432/cozychat"
    - "postgresql://user:password@replica2:5432/cozychat"
```

## 3. 数据库表设计

### 3.1 用户系统

#### users（用户表）

```sql
CREATE TABLE users (
    -- 主键
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- 基本信息
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    
    -- 角色和状态
    role VARCHAR(20) NOT NULL DEFAULT 'user', -- admin / user / guest
    status VARCHAR(20) NOT NULL DEFAULT 'active', -- active / suspended / deleted
    
    -- 个人资料
    display_name VARCHAR(100),
    avatar_url TEXT,
    bio TEXT,
    
    -- 偏好设置（JSONB）
    preferences JSONB NOT NULL DEFAULT '{
        "default_personality": "health_assistant",
        "language": "zh-CN",
        "theme": "light",
        "auto_tts": false,
        "show_reasoning": false
    }'::jsonb,
    
    -- 认证相关
    email_verified BOOLEAN NOT NULL DEFAULT false,
    email_verified_at TIMESTAMP,
    last_login_at TIMESTAMP,
    last_login_ip INET,
    
    -- 统计信息
    total_sessions INTEGER NOT NULL DEFAULT 0,
    total_messages INTEGER NOT NULL DEFAULT 0,
    total_tokens_used BIGINT NOT NULL DEFAULT 0,
    
    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    
    -- 索引
    CONSTRAINT check_role CHECK (role IN ('admin', 'user', 'guest')),
    CONSTRAINT check_status CHECK (status IN ('active', 'suspended', 'deleted'))
);

-- 索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);

-- 全文搜索索引
CREATE INDEX idx_users_search ON users USING gin(
    to_tsvector('simple', coalesce(username, '') || ' ' || coalesce(display_name, ''))
);
```

#### user_profiles（用户画像）

```sql
CREATE TABLE user_profiles (
    -- 主键和外键
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    
    -- 兴趣标签
    interests TEXT[] NOT NULL DEFAULT '{}',
    
    -- 使用习惯（JSONB）
    habits JSONB NOT NULL DEFAULT '{
        "most_active_time": "evening",
        "avg_session_duration_minutes": 0,
        "favorite_topics": []
    }'::jsonb,
    
    -- 人格洞察（JSONB）
    personality_insights JSONB NOT NULL DEFAULT '{
        "communication_style": "",
        "question_types": [],
        "interaction_patterns": {}
    }'::jsonb,
    
    -- 统计数据（JSONB）
    statistics JSONB NOT NULL DEFAULT '{}'::jsonb,
    
    -- 时间戳
    generated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

#### user_api_keys（用户API密钥）

```sql
CREATE TABLE user_api_keys (
    -- 主键
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- 外键
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- API Key信息
    key_hash VARCHAR(255) NOT NULL UNIQUE,
    key_prefix VARCHAR(10) NOT NULL, -- 前缀用于展示（如 'ck_abc...'）
    name VARCHAR(100) NOT NULL,
    description TEXT,
    
    -- 权限和限制
    scopes TEXT[] NOT NULL DEFAULT '{}', -- ['chat', 'audio', 'memory']
    rate_limit INTEGER, -- 每分钟请求数
    
    -- 状态
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    last_used_at TIMESTAMP,
    
    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,
    revoked_at TIMESTAMP,
    
    CONSTRAINT check_status CHECK (status IN ('active', 'revoked', 'expired'))
);

-- 索引
CREATE INDEX idx_user_api_keys_user_id ON user_api_keys(user_id);
CREATE INDEX idx_user_api_keys_key_hash ON user_api_keys(key_hash);
CREATE INDEX idx_user_api_keys_status ON user_api_keys(status);
```

### 3.2 会话和消息

#### sessions（会话表）

```sql
CREATE TABLE sessions (
    -- 主键
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- 外键
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    personality_id VARCHAR(100) NOT NULL,
    
    -- 会话信息
    title VARCHAR(255) NOT NULL DEFAULT '新会话',
    
    -- 元数据（JSONB）
    metadata JSONB NOT NULL DEFAULT '{}'::jsonb,
    
    -- 统计信息
    message_count INTEGER NOT NULL DEFAULT 0,
    total_tokens_used INTEGER NOT NULL DEFAULT 0,
    
    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_message_at TIMESTAMP,
    deleted_at TIMESTAMP
);

-- 索引
CREATE INDEX idx_sessions_user_id ON sessions(user_id);
CREATE INDEX idx_sessions_personality_id ON sessions(personality_id);
CREATE INDEX idx_sessions_created_at ON sessions(created_at DESC);
CREATE INDEX idx_sessions_last_message_at ON sessions(last_message_at DESC);

-- 复合索引
CREATE INDEX idx_sessions_user_active ON sessions(user_id, deleted_at) 
WHERE deleted_at IS NULL;
```

#### messages（消息表）

```sql
CREATE TABLE messages (
    -- 主键
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- 外键
    session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- 消息内容
    role VARCHAR(20) NOT NULL, -- user / assistant / system / tool
    content TEXT NOT NULL,
    
    -- AI生成信息（仅role=assistant时）
    model VARCHAR(100),
    temperature FLOAT,
    tokens_used JSONB, -- {"prompt": 100, "completion": 50, "total": 150}
    
    -- 工具调用（JSONB）
    tool_calls JSONB,
    
    -- 记忆使用（JSONB）
    memories_used JSONB, -- [{"id": "mem_123", "similarity": 0.85}]
    
    -- 元数据
    metadata JSONB NOT NULL DEFAULT '{}'::jsonb,
    
    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_role CHECK (role IN ('user', 'assistant', 'system', 'tool'))
);

-- 索引
CREATE INDEX idx_messages_session_id ON messages(session_id);
CREATE INDEX idx_messages_user_id ON messages(user_id);
CREATE INDEX idx_messages_created_at ON messages(created_at DESC);
CREATE INDEX idx_messages_role ON messages(role);

-- 复合索引
CREATE INDEX idx_messages_session_created ON messages(session_id, created_at DESC);

-- 全文搜索索引
CREATE INDEX idx_messages_content_search ON messages USING gin(
    to_tsvector('simple', content)
);
```

### 3.3 人格系统

#### personalities（人格表）

```sql
CREATE TABLE personalities (
    -- 主键
    id VARCHAR(100) PRIMARY KEY,
    
    -- 外键（如果是用户自定义）
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    
    -- 基本信息
    name VARCHAR(255) NOT NULL,
    description TEXT,
    icon VARCHAR(10),
    tags TEXT[] NOT NULL DEFAULT '{}',
    
    -- 完整配置（JSONB）
    config JSONB NOT NULL,
    
    -- 状态
    is_default BOOLEAN NOT NULL DEFAULT false,
    is_public BOOLEAN NOT NULL DEFAULT false,
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    
    -- 统计
    usage_count INTEGER NOT NULL DEFAULT 0,
    
    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_status CHECK (status IN ('active', 'archived', 'deleted'))
);

-- 索引
CREATE INDEX idx_personalities_user_id ON personalities(user_id);
CREATE INDEX idx_personalities_is_public ON personalities(is_public);
CREATE INDEX idx_personalities_status ON personalities(status);
CREATE INDEX idx_personalities_usage_count ON personalities(usage_count DESC);

-- GIN索引用于标签搜索
CREATE INDEX idx_personalities_tags ON personalities USING gin(tags);
```

### 3.4 记忆系统（关系数据）

#### memory_metadata（记忆元数据）

```sql
CREATE TABLE memory_metadata (
    -- 主键（与向量数据库的ID对应）
    id UUID PRIMARY KEY,
    
    -- 外键
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    session_id UUID REFERENCES sessions(id) ON DELETE CASCADE,
    
    -- 记忆类型和内容
    memory_type VARCHAR(20) NOT NULL, -- user / ai / system
    content TEXT NOT NULL,
    
    -- 重要性和质量
    importance FLOAT NOT NULL DEFAULT 0.5,
    quality_score FLOAT,
    
    -- 分类
    category VARCHAR(50),
    tags TEXT[] NOT NULL DEFAULT '{}',
    
    -- 关联
    related_memory_ids UUID[] NOT NULL DEFAULT '{}',
    
    -- 元数据
    metadata JSONB NOT NULL DEFAULT '{}'::jsonb,
    
    -- 访问统计
    access_count INTEGER NOT NULL DEFAULT 0,
    last_accessed_at TIMESTAMP,
    
    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,
    
    CONSTRAINT check_memory_type CHECK (memory_type IN ('user', 'ai', 'system'))
);

-- 索引
CREATE INDEX idx_memory_metadata_user_id ON memory_metadata(user_id);
CREATE INDEX idx_memory_metadata_session_id ON memory_metadata(session_id);
CREATE INDEX idx_memory_metadata_memory_type ON memory_metadata(memory_type);
CREATE INDEX idx_memory_metadata_importance ON memory_metadata(importance DESC);
CREATE INDEX idx_memory_metadata_created_at ON memory_metadata(created_at DESC);
CREATE INDEX idx_memory_metadata_expires_at ON memory_metadata(expires_at);

-- GIN索引
CREATE INDEX idx_memory_metadata_tags ON memory_metadata USING gin(tags);

-- 全文搜索索引
CREATE INDEX idx_memory_content_search ON memory_metadata USING gin(
    to_tsvector('simple', content)
);
```

### 3.5 工具系统

#### tool_usage_logs（工具使用日志）

```sql
CREATE TABLE tool_usage_logs (
    -- 主键
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- 外键
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    session_id UUID REFERENCES sessions(id) ON DELETE SET NULL,
    message_id UUID REFERENCES messages(id) ON DELETE SET NULL,
    
    -- 工具信息
    tool_name VARCHAR(255) NOT NULL,
    tool_type VARCHAR(20) NOT NULL, -- builtin / mcp
    
    -- 调用信息
    parameters JSONB NOT NULL,
    result TEXT,
    
    -- 执行状态
    status VARCHAR(20) NOT NULL, -- success / failure / timeout
    error_message TEXT,
    execution_time_ms INTEGER,
    
    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_tool_type CHECK (tool_type IN ('builtin', 'mcp')),
    CONSTRAINT check_status CHECK (status IN ('success', 'failure', 'timeout'))
);

-- 索引
CREATE INDEX idx_tool_usage_logs_user_id ON tool_usage_logs(user_id);
CREATE INDEX idx_tool_usage_logs_tool_name ON tool_usage_logs(tool_name);
CREATE INDEX idx_tool_usage_logs_created_at ON tool_usage_logs(created_at DESC);
CREATE INDEX idx_tool_usage_logs_status ON tool_usage_logs(status);
```

### 3.6 系统监控

#### api_requests（API请求日志）

```sql
CREATE TABLE api_requests (
    -- 主键
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- 用户和请求信息
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    api_key_id UUID REFERENCES user_api_keys(id) ON DELETE SET NULL,
    
    -- 请求详情
    endpoint VARCHAR(255) NOT NULL,
    method VARCHAR(10) NOT NULL,
    
    -- 响应信息
    status_code INTEGER NOT NULL,
    response_time_ms INTEGER NOT NULL,
    
    -- 错误信息
    error_code VARCHAR(50),
    error_message TEXT,
    
    -- 元数据
    user_agent TEXT,
    ip_address INET,
    request_id VARCHAR(100),
    
    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_api_requests_user_id ON api_requests(user_id);
CREATE INDEX idx_api_requests_created_at ON api_requests(created_at DESC);
CREATE INDEX idx_api_requests_endpoint ON api_requests(endpoint);
CREATE INDEX idx_api_requests_status_code ON api_requests(status_code);

-- 分区（按月）
-- ALTER TABLE api_requests PARTITION BY RANGE (created_at);
```

#### system_metrics（系统指标）

```sql
CREATE TABLE system_metrics (
    -- 主键
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- 指标类型
    metric_type VARCHAR(50) NOT NULL, -- cpu / memory / disk / api / db
    
    -- 指标数据（JSONB）
    metrics JSONB NOT NULL,
    
    -- 时间戳
    recorded_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_system_metrics_type ON system_metrics(metric_type);
CREATE INDEX idx_system_metrics_recorded_at ON system_metrics(recorded_at DESC);

-- 自动清理旧数据（保留30天）
-- CREATE POLICY delete_old_metrics 
-- ON system_metrics 
-- FOR DELETE 
-- USING (recorded_at < NOW() - INTERVAL '30 days');
```

## 4. 数据库迁移

### 4.1 Alembic配置

```python
# alembic/env.py
from logging.config import fileConfig
from sqlalchemy import engine_from_config, pool
from alembic import context
from app.models.base import Base
from app.db.session import get_database_url

# 配置
config = context.config
config.set_main_option('sqlalchemy.url', get_database_url())

# 导入所有模型
from app.models import user, session, message, personality, memory

# 目标元数据
target_metadata = Base.metadata

def run_migrations_online():
    connectable = engine_from_config(
        config.get_section(config.config_ini_section),
        prefix='sqlalchemy.',
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata
        )

        with context.begin_transaction():
            context.run_migrations()
```

### 4.2 创建迁移脚本

```bash
# 生成新的迁移
alembic revision --autogenerate -m "Add user profiles table"

# 应用迁移
alembic upgrade head

# 回滚
alembic downgrade -1
```

## 5. 数据备份和恢复

### 5.1 备份策略

```yaml
backup:
  # 完整备份
  full_backup:
    schedule: "0 2 * * 0"  # 每周日凌晨2点
    retention: 30  # 保留30天
    
  # 增量备份
  incremental_backup:
    schedule: "0 3 * * *"  # 每天凌晨3点
    retention: 7  # 保留7天
    
  # 事务日志备份
  wal_backup:
    enabled: true
    retention: 7  # 保留7天
```

### 5.2 备份脚本

```bash
#!/bin/bash
# scripts/backup_database.sh

BACKUP_DIR="/backup/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
DATABASE="cozychat"

# 完整备份
pg_dump -Fc $DATABASE > $BACKUP_DIR/full_backup_$DATE.dump

# 压缩
gzip $BACKUP_DIR/full_backup_$DATE.dump

# 清理旧备份
find $BACKUP_DIR -name "full_backup_*.dump.gz" -mtime +30 -delete

echo "Backup completed: full_backup_$DATE.dump.gz"
```

## 6. 性能优化

### 6.1 连接池配置

```python
# app/db/session.py
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import NullPool, QueuePool

engine = create_engine(
    DATABASE_URL,
    pool_size=20,           # 连接池大小
    max_overflow=10,        # 最大溢出连接数
    pool_timeout=30,        # 获取连接超时
    pool_recycle=3600,      # 连接回收时间
    pool_pre_ping=True,     # 连接前检查
    echo=False,             # 不打印SQL
    poolclass=QueuePool     # 使用队列池
)

SessionLocal = sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine
)
```

### 6.2 查询优化

```python
# 使用eager loading避免N+1查询
from sqlalchemy.orm import joinedload, selectinload

# 示例：获取会话及其所有消息
session = db.query(Session).options(
    selectinload(Session.messages)
).filter(Session.id == session_id).first()

# 使用索引hints
from sqlalchemy import text

query = db.query(User).filter(
    text("username = :username COLLATE \"C\"")
).params(username=username)
```

### 6.3 批量操作

```python
# 批量插入
from sqlalchemy import insert

stmt = insert(Message).values([
    {"session_id": sid, "content": "msg1"},
    {"session_id": sid, "content": "msg2"},
])
db.execute(stmt)

# 批量更新
from sqlalchemy import update

stmt = update(Session).where(
    Session.user_id == user_id
).values(updated_at=datetime.now())
db.execute(stmt)
```

## 7. 数据安全

### 7.1 敏感数据加密

```python
# app/utils/security.py
from cryptography.fernet import Fernet
import os

# 加密密钥（从环境变量读取）
ENCRYPTION_KEY = os.getenv('ENCRYPTION_KEY')
cipher = Fernet(ENCRYPTION_KEY.encode())

def encrypt_data(data: str) -> str:
    """加密敏感数据"""
    return cipher.encrypt(data.encode()).decode()

def decrypt_data(encrypted: str) -> str:
    """解密数据"""
    return cipher.decrypt(encrypted.encode()).decode()
```

### 7.2 数据访问控制

```sql
-- 创建只读用户
CREATE USER readonly_user WITH PASSWORD 'password';
GRANT CONNECT ON DATABASE cozychat TO readonly_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

-- 创建应用用户
CREATE USER app_user WITH PASSWORD 'password';
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO app_user;
```

---

**文档版本**: v1.0  
**最后更新**: 2025-11-06

